<style type="text/css">
h1 {
	color: white;
	margin: 1rem;
	font-weight: 700;
	text-align: center;
}
.card.flay > .card-body {
	padding: 0.125rem;
}
.card.flay > .card-body > .card-title {
	margin-bottom: 0;
}
.card.flay > .card-body > .card-text {
	margin: 0;
}

#tagInput .form-row {
	width: 800px;
}

#tagList {
	text-align: center;
	margin-top: 60px;
}
#tagList .tag {
	cursor: pointer;
	display: inline-flex;
	margin: 0.5rem;
	width: 200px;
}
#tagList .active {
	background-color: rgba(85, 136, 136, .75);
	color: #eee;
}

#tagDetail {
	display: none;
    border-radius: 0.5rem;
    background-color: rgba(255, 255, 255, 0.5);
	margin: 1rem;
    padding: 1rem;
}
#tagDetail .flay-list {
	text-align: center;
}
#tagDetail .flay-list .flay {
    display: inline-flex;
    background: #00f center no-repeat;
    background-size: cover;
    border: 0;
    border-radius: 0.25rem;
    text-align: left;
	margin: 0.5rem;
    width: 300px;
    height: calc(300px * var(--cover-ratio));
}
#tagDetail .flay-list .flay .title {
	max-width: 290px;
}

</style>

<div role="body">

	<nav class="navbar navbar-expand-sm fixed-top bg-light navbar-light justify-content-center">
		<div id="tagInput">
			<div class="form-row">
				<div class="col-sm-1">
					<input type="text" class="form-control form-control-sm" id="tagId" placeholder="Id">
				</div>
				<div class="col-sm-4">
					<input type="text" class="form-control form-control-sm" id="tagName" placeholder="Name">
				</div>
				<div class="col">
					<input type="text" class="form-control form-control-sm" id="tagDesc" placeholder="Desctiption">
				</div>
				<div class="col-auto">
					<button class="btn btn-sm tag-save">Save</button>
				</div>
				<div class="col-auto">
					<button class="btn btn-sm btn-danger tag-delete">Delete</button>
				</div>
			</div>
		</div>
	</nav>
	
	<div id="tagList">
		<div class="card tag">
			<div class="card-body">
				<span class="badge badge-pill badge-dark float-right video-count"></span>
				<h5 class="card-title font-weight-bold">Tag name</h5>
				<p class="card-text text-primary">Tag description</p>
			</div>
		</div>
	</div>
	
	<div id="tagDetail">
		<label class="float-right hover"><i class="fa fa-times"></i></label>
		<div class="flay-list">
			<div class="card flay">
				<div class="card-body">
					<h5 class="card-title"><label class="text sm title nowrap">Title</label></h5>
					<p class="card-text actress nowrap"></p>
					<p class="card-text"><label class="text sm opus">Opus</label></p>
					<p class="card-text"><label class="text sm release">Release</label></p>
					<p class="card-text"><label class="text sm movie">Movie</label></p>
				</div>
			</div>
		</div>
	</div>

</div>
<script type="text/javascript">
var $tagTemplete  = $(".tag");
var $flayTemplete = $(".flay");

$(".fa-times").on("click", function() {
	$("#tagDetail").hide();
});

$(".tag-save").on("click", function() {
	var id = $("#tagId").val(), name = $("#tagName").val(), desc = $("#tagDesc").val();
	if (name === '') {
		return;
	}
	var tag = {id: id, name: name, description: desc};
	if (id === '') {
		Rest.Tag.create(tag, tagLoad);
	} else {
		Rest.Tag.update(tag, tagLoad);
	}
});

$(".tag-delete").on("click", function() {
	if (confirm('Delete this tag?')) {
		var tag = $("#tagInput").data("tag");
		Rest.Tag.delete(tag, function() {
			tagLoad();
			$("#tagId, #tagName, #tagDesc").val('');
			$("#tagDetail").hide();
		});
	}
});

function tagLoad() {
	Rest.Tag.list(function(tagList) {
		Util.Tag.sort(tagList);
		var $tagList = $("#tagList").empty();
		
		$.each(tagList, function(idx, tag) {
			var $tagCard = $tagTemplete.clone();
			$tagCard.data("tag", tag);
			$tagCard.find(".card-title").html(tag.name);
			$tagCard.find(".card-text").html(tag.description);
			$tagCard.on("click", function() {
				tagDetail(this);
			});

			$tagList.append($tagCard);
		});
	});
}

function tagDetail(tagCard) {
	$("#tagList .active").removeClass("active");
	var $tagCard  = $(tagCard);
	var tag       = $tagCard.addClass("active").data("tag");
	var $flayList = $(".flay-list");
	
	$("#tagInput").data("tag", tag);
	$("#tagId").val(tag.id);
	$("#tagName").val(tag.name);
	$("#tagDesc").val(tag.description);
	$flayList.empty();
	
	Rest.Flay.findByTag(tag, function(flayList) {
		$("#tagDetail").toggle(flayList.length > 0);
		$tagCard.find(".video-count").html(flayList.length);
		
		$.each(flayList, function(idx, flay) {
			$flay = $flayTemplete.clone();
			$flay.css({backgroundImage: 'url(' + PATH + '/static/cover/' + flay.opus + ')'});
			$flay.find(".title").html(flay.title).on("click", function() {
				View.flay(flay.opus);
			});
			var $actressWrap = $flay.find(".actress");
			$.each(flay.actressList, function(idx2, actressName) {
				Rest.Actress.get(actressName, function(actress) {
					$("<label>", {'class': 'text sm'}).html(actress.name).on("click", function() {
						View.actress(actress.name);
					}).appendTo($actressWrap);
				});
			});
			$flay.find(".opus").html(flay.opus);
			$flay.find(".release").html(flay.release);
			$flay.find(".movie").html(
					flay.files.movie.length === 0 ? '' : 
						flay.files.movie.length === 1 ? 'V ' + formatFilesize(flay.length) :
							flay.files.movie.length + 'V ' + formatFilesize(flay.length)
			).on("click", function() {
				Rest.Flay.play(flay);
			});
			
			$flayList.append($flay);
		});
	});
}

tagLoad();

</script>