<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Image view</title>
<link rel="icon" type="image/png" href="/img/favicon/flay_0.png"/>
<link rel="stylesheet" href="/webjars/fontawesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/webjars/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/webjars/jquery-ui/themes/base/jquery-ui.min.css"/>
<link rel="stylesheet" href="/css/crazy.common.css"/>
<link rel="stylesheet" href="/css/crazy.common.range.css"/>
<style type="text/css">
body {
	overflow: hidden;
}
img.img-responsive {
	max-width: 100%;
	max-height: 100%;
}
.overlay {
	opacity:0;
	transition: .5s ease;
}
.img-magnifier-container .overlay:hover {
  	opacity: 1;
}

#info {
	position: fixed;
	right: 0;
	bottom: 0;
	padding: 2px;
	text-align: right;
	background-color: rgba(0, 0, 0, .5);
	border-top-left-radius: 4px;
}
#info > span {
	margin: 2px;
	display: inline-block;
	font-size: 14px;
	color: #eee;
	text-shadow: 1px 1px 2px #111;
	transition: all .3s;
}
#info > span#magnifier, #info > span#path {
    cursor: pointer;
}
#info > span#magnifier:hover, #info > span#path:hover {
    color: OrangeRed;
    text-shadow: 1px 1px 2px #2d2d2d;
}
#info > span#moveOut {
	padding: 0 2px;
    cursor: pointer;
}
#info > span#moveOut:hover {
    /* color: #f00; */
    font-weight: bold;
    text-shadow: 1px 1px 2px #4c4c4c;
	background-color: rgba(255, 0, 0, .5);
    border-radius: 4px;    
}
#info > span#iname {
	color: yellow;
}
#info > span#length, 
#info > span#lastModified {
	font-size: 80%;
}

.img-magnifier-container {
  	position:relative;
}
.img-magnifier-glass {
  	position: absolute;
  	border: 1px solid #f00;
  	border-radius: 50%;
  	cursor: none;
  	/*Set the size of the magnifier glass:*/
  	width: 200px;
  	height: 200px;
  	/* opacity: 0; */
  	display: none;
}
.img-magnifier-container:hover .img-magnifier-glass {
	/* opacity: 1; */
	display: block;
} 
</style>
<script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/webjars/popper.js/umd/popper.js"></script>
<script type="text/javascript" src="/webjars/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/webjars/jquery-ui/jquery-ui.min.js"></script>
<script type="text/javascript" src="/js/crazy.common.js"></script>
<script type="text/javascript" src="/js/crazy.jquery.js"></script>
<script type="text/javascript" src="/js/flay.rest.service.js"></script>
<script type="text/javascript" src="/js/flay.utils.js"></script>
<script type="text/javascript">
$(document).ready(function() {
	app();
});

var getBrowserMargin = function() {
	var margin = {width: 0, height: 0};
	if (system === LINUX) {
		if (browser === CHROME) {
   			margin.width = 0;
   			margin.height = 28;
   		} else if (browser === FIREFOX) {
   			margin.width = 0;
   			margin.height = 37;
   		}
	} else if (system === WINDOWS) {
   		if (browser === MSIE) {
   			alert("Microsoft IE not support");
   		} else if (browser === CHROME) {
   			margin.width = 16;
   			margin.height = 67;
   		} else if (browser === FIREFOX) {
   			margin.width = 16;
   			margin.height = 76;
   		} else if (browser === EDGE) {
   			margin.width = 0;
   			margin.height = 45;
   		}
	}
	console.log(system, browser, margin, agent);
	return margin;
};


var app = function() {
	// parameter
	var no  = reqParam.no;
	var src = reqParam.src;
	var imgSrc = no ? PATH + '/static/image/' + no : PATH + src;
	
	// get image
	var img = new Image();
	img.onload = function() {
		$("#image").attr({
			'src': this.src
		}).on("click", function() { 
			$(this).toggleClass('img-responsive');
		});
		$("#size").html(this.naturalWidth + ' x ' + this.naturalHeight);
		
  		// magnifier glass
		var magnifierOnOff = true;
  		$("#magnifier").on("click", function() {
   			magnify("image", 3, magnifierOnOff);
   			magnifierOnOff = !magnifierOnOff;
        });

		// popup resize
 		var browserMargin = getBrowserMargin();
  		window.resizeTo(this.naturalWidth + browserMargin.width, this.naturalHeight + browserMargin.height);
	};
	img.src = imgSrc;
	
	if (no != null) {
		// set image infomation
        Rest.Image.get(no, function(imageInfo) {
			// title set
   	        document.title = imageInfo.name;
	        // #path: open folder
	        $("#path").html(imageInfo.path).on("click", function() {
				Rest.Flay.openFolder(imageInfo.path);
		    });
			// #iname
			$("#iname").html(imageInfo.name);
			// #length
			$("#length").html(File.formatSize(imageInfo.length));
			// #lastModified
			$("#lastModified").html(new Date(imageInfo.modified).format("yyyy-MM-dd"));
			// #moveOut
			$("#moveOut").on("click", function() {
	        	if (confirm('move this file to Root Directory?'))
		        	Rest.Image.delete(no);
	        });
        });
	}
};


function magnify(imgID, zoom, onOff) {
	var img, glass, w, h, bw;
	img = document.getElementById(imgID);

	if (onOff) {
		/*create magnifier glass:*/
		glass = document.createElement("DIV");
		glass.setAttribute("class", "img-magnifier-glass");
		/*insert magnifier glass:*/
		img.parentElement.insertBefore(glass, img);
		/*set background properties for the magnifier glass:*/
		glass.style.backgroundImage = "url('" + img.src + "')";
		glass.style.backgroundRepeat = "no-repeat";
		glass.style.backgroundSize = (img.width * zoom) + "px " + (img.height * zoom) + "px";
		bw = 3;
		w = glass.offsetWidth / 2;
		h = glass.offsetHeight / 2;
		/*execute a function when someone moves the magnifier glass over the image:*/
		glass.addEventListener("mousemove", moveMagnifier);
		img.addEventListener("mousemove", moveMagnifier);
		/*and also for touch screens:*/
		//glass.addEventListener("touchmove", moveMagnifier);
		//img.addEventListener("touchmove", moveMagnifier);
	} else {
		glass = document.querySelector("DIV.img-magnifier-glass")
		glass.removeEventListener("mousemove", moveMagnifier);
		img.removeEventListener("mousemove", moveMagnifier);
		//glass.removeEventListener("touchmove", moveMagnifier);
		//img.removeEventListener("touchmove", moveMagnifier);
		glass.remove();
	}
	function moveMagnifier(e) {
		var pos, x, y;
	    /*prevent any other actions that may occur when moving over the image*/
	    e.preventDefault();
	    /*get the cursor's x and y positions:*/
	    pos = getCursorPos(e);
	    x = pos.x;
	    y = pos.y;
	    /*prevent the magnifier glass from being positioned outside the image:*/
	    if (x > img.width - (w / zoom)) {x = img.width - (w / zoom);}
	    if (x < w / zoom) {x = w / zoom;}
	    if (y > img.height - (h / zoom)) {y = img.height - (h / zoom);}
	    if (y < h / zoom) {y = h / zoom;}
	    /*set the position of the magnifier glass:*/
	    glass.style.left = (x - w) + "px";
	    glass.style.top = (y - h) + "px";
	    /*display what the magnifier glass "sees":*/
	    glass.style.backgroundPosition = "-" + ((x * zoom) - w + bw) + "px -" + ((y * zoom) - h + bw) + "px";
	}
	function getCursorPos(e) {
	    var a, x = 0, y = 0;
	    e = e || window.event;
	    /*get the x and y positions of the image:*/
	    a = img.getBoundingClientRect();
	    /*calculate the cursor's x and y coordinates, relative to the image:*/
	    x = e.pageX - a.left;
	    y = e.pageY - a.top;
	    /*consider any page scrolling:*/
	    x = x - window.pageXOffset;
	    y = y - window.pageYOffset;
	    return {x : x, y : y};
	}
}
</script>
</head>
<body>

	<div class="img-magnifier-container">
		<img id="image" class="img-responsive"/>
		<div id="info" class="overlay">
			<span id="magnifier"><i class="fa fa-search"></i></span>
			<span id="path"></span>
			<span id="iname"></span>
			<span id="size"></span>
			<span id="length"></span>
			<span id="lastModified"></span>
			<span id="moveOut"><i class="fa fa-times"></i></span>
		</div>
	</div>
	
</body>
</html>