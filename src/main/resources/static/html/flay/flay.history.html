<style type="text/css">
#chartdiv {
	width: 100%;
	height: 400px;
}
</style>

<div role="body">

	<nav class="navbar navbar-expand-sm fixed-top bg-light navbar-light justify-content-center">
		<button class="btn btn-flay btn-sm" data-toggle="collapse" data-target="#historyOfPlay">History of Play</button>
		<div class="divider"></div>
	</nav>
	<div style="height: 55px;"></div>

	<div id="historyOfPlay" class="collapse">
		<div id="chartdiv"></div>
	</div>

</div>

<script type="text/javascript" src="/webjars/amcharts/amcharts.js"></script>
<script type="text/javascript" src="/webjars/amcharts/serial.js"></script>
<script type="text/javascript" src="/webjars/amcharts/themes/black.js"></script>
<script type="text/javascript">
var dataArray = [];

$(window).on("resize", function() {
	$("#chartdiv").css({
		height: $(window).height() - 60
	});
}).trigger('resize');

$("#historyOfPlay").on('show.bs.collapse', function() {
	drawGraph(dataArray);
});

loading.on("Loading history");

Rest.History.findAction('PLAY', function(list) {
	var dataMap = {};
	$.each(list, function(idx, history) {
		var key = history.date.substring(0, 10);
		if (dataMap[key]) {
			dataMap[key].push(history);
		} else {
			dataMap[key] = [history];
		}
	});
	
	$.each(dataMap, function(key, val) {
		dataArray.push({
			date: key,
			playCount: val.length
		});
	});
	dataArray.sort(function(d1, d2) {
		return d1.date.localeCompare(d2.date);
	});
	console.log("dataArray", dataArray.length);

	loading.off();
});

function drawGraph(data) {
	var chart = AmCharts.makeChart("chartdiv", {
		"type": "serial",
		"theme": "black",
		"dataProvider": data,
		"mouseWheelZoomEnabled": true,
		"startDuration": 0,
		"dataDateFormat": "YYYY-MM-DD",
		"valueAxes": [{
		    "gridAlpha": 0.2,
		    "dashLength": 1
		}],
		"graphs": [{
			"id": "playCount",
		    "type": "column",
		    "valueField": "playCount",
		    "fillColors": "#FFFF00",
		    "fillAlphas": 0.8,
		    "lineAlpha": 0,
		    "balloonText": "<b>[[value]]</b>",
		    "balloon": {
	            "drop": true
	        }
		}],
		"chartScrollbar": {
	        "graph": "playCount",
	        "autoGridCount": true,
	        "scrollbarHeight": 40,
	    },
		"chartCursor": {
			"limitToGraph": "playCount"
		},
		"categoryField": "date",
		"categoryAxis": {
	        "parseDates": true,
	        "dashLength": 1,
	        "minorGridEnabled": true
	    },
	});

	chart.addListener("rendered", zoomChart);

	zoomChart();
	
	function zoomChart() {
//	    chart.zoomToIndexes(chart.dataProvider.length - 10, chart.dataProvider.length - 1);

		var width = $(window).width();

	    var toDay = new Date();
	    var fromDay = new Date();
	    fromDay.setMonth(toDay.getMonth() - Math.round(width/10/60));
	    chart.zoomToDates(fromDay, toDay);
	}

}

</script>