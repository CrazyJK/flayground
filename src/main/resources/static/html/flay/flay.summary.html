<style type="text/css">
.flay-list-wrapper {
	display: none;
    background-color: rgba(240, 248, 255, 0.5);
    border-radius: 0.5rem;
    margin: 1rem;
    padding: 1rem;
}

.summary-list {
	text-align: center;
}
.summary-list > .summary-item {
	display: inline-block;
	border: 1px solid var(--primary);
	border-radius: .25rem;
	margin: .5rem;
	padding: .25rem;
	transition: all .3s;
}
.summary-list > .summary-item:hover {
	background-color: var(--primary);
	color: var(--light);
}

.summary-item > .item-key {
	margin: .25rem;
	text-align: left;
}
.summary-item > .item-count {
	margin: .25rem;
	min-width: 30px;
}
.summary-item > .item-size {
	margin: .25rem;
	min-width: 70px;
	text-align: right;
}

#pathList .item-key {
	width: 200px;
}
</style>

<div role="body">

	<nav class="navbar navbar-expand-sm fixed-top bg-light navbar-light justify-content-center">
		<button class="btn btn-primary btn-sm" data-toggle="collapse" data-target="#groupByStudio">Group By Studio</button>
		<div class="divider"></div>
		<button class="btn btn-primary btn-sm" data-toggle="collapse" data-target="#groupByRelease">Group By Release</button>
		<div class="divider"></div>
		<button class="btn btn-primary btn-sm" data-toggle="collapse" data-target="#groupByPath">Group By Path</button>
		<div class="divider"></div>
		<button class="btn btn-primary btn-sm" data-toggle="collapse" data-target="#groupByRank">Group By Rank</button>
	</nav>

	<div style="height: 55px;"></div>

	<div id="groupByStudio" class="collapse card m-2">
		<div class="card-header text-center">
			Grouped by Studio
		</div>
		<div class="card-body">
			<div class="summary-list" id="studioList"></div>
		</div>
	</div>

	<div id="groupByRelease" class="collapse card m-2">
		<div class="card-header text-center"> Choose release pattern
			<span class="input-group">
				<label><input type="radio" name="releasePattern" value="YYYY"><span>YYYY</span></label>
				<label><input type="radio" name="releasePattern" value="YYYYMM"><span>YYYY.MM</span></label>
				<label><input type="radio" name="releasePattern" value="YYYYMMDD"><span>YYYY.MM.DD</span></label>
			</span>
		</div>
		<div class="card-body">
			<div class="summary-list" id="releasedList"></div>
		</div>
	</div>

	<div id="groupByPath" class="collapse card m-2">
		<div class="card-header text-center">
			Parent path based
		</div>
		<div class="card-body">
			<div class="summary-list" id="pathList"></div>
		</div>
	</div>

	<div id="groupByRank" class="collapse card m-2">
		<div class="card-header text-center">
			Grouped by rank
		</div>
		<div class="card-body">
			<div class="summary-list" id="rankList"></div>
		</div>
	</div>

	<div class="flay-list-wrapper">
		<i class="fa fa-times float-right" onclick="$(this).parent().hide()"></i>
		<h4 class="text-center mt-1">
			<label class="text" id="groupByKey"></label> 
		</h4>
		<div class="text-center mt-2 flay-list" id="flayList"></div>
	</div>

</div>

<script type="text/javascript">
var flayList = [];
Rest.Flay.list(function(list) {
	flayList = list;
});

$("#groupByRelease").on('show.bs.collapse', function() {
	var val = $("input[name='releasePattern']:checked").val();
	if (typeof val === 'undefined') {
		$("input[name='releasePattern']").first().click();
	}
});

$("input[name='releasePattern']").on('change', function() {
	var releasePattern = $("input[name='releasePattern']:checked").val();
	var getReleaseKey = function(release) {
		if ('YYYY' === releasePattern) {
			return release.substring(0, 4);
		} else if ('YYYYMM' === releasePattern) {
			return release.substring(0, 7);
		} else {
			return release;
		}
	};
	var $list = $("#releasedList").empty();
	
	var dataMap = {};
	$.each(flayList, function(idx, flay) {
		var key = getReleaseKey(flay.release);
		if (dataMap[key]) {
			dataMap[key].push(flay);
		} else {
			dataMap[key] = [flay];
		}
	});
	
	displaySummaryItem(dataMap, $list);
});

$("#groupByPath").on('show.bs.collapse', function() {
	var getPathKey = function(files) {
		var file;
		if (files.movie.length > 0) {
			file = files.movie[0];
		} else {
			file = files.cover[0];
		}
		var pathArray = file.replace(/\\/gi, '/').split('/');
		pathArray.pop();
		return pathArray.join('/');
	};
	var $list = $("#pathList").empty();
	
	var dataMap = {};
	$.each(flayList, function(idx, flay) {
		var key = getPathKey(flay.files);
		if (dataMap[key]) {
			dataMap[key].push(flay);
		} else {
			dataMap[key] = [flay];
		}
	});
	
	displaySummaryItem(dataMap, $list);
});

$("#groupByRank").on('show.bs.collapse', function() {
	var $list = $("#rankList").empty();
	
	var dataMap = {};
	$.each(flayList, function(idx, flay) {
		var key = 'Rank ' + flay.video.rank;
		if (dataMap[key]) {
			dataMap[key].push(flay);
		} else {
			dataMap[key] = [flay];
		}
	});
	
	displaySummaryItem(dataMap, $list);
});

$("#groupByStudio").on('show.bs.collapse', function() {
	var $list = $("#studioList").empty();
	
	var dataMap = {};
	$.each(flayList, function(idx, flay) {
		var key = flay.studio;
		if (dataMap[key]) {
			dataMap[key].push(flay);
		} else {
			dataMap[key] = [flay];
		}
	});
	
	displaySummaryItem(dataMap, $list);
});


function displaySummaryItem(dataMap, $list) {
	var dataArray = [];
	$.each(dataMap, function(key, val) {
		dataArray.push({
			key: key,
			list: val
		});
	});
	dataArray.sort(function(d1, d2) {
		return d1.key.localeCompare(d2.key);
	});
	
	$.each(dataArray, function(idx, data) {
		$("<div>", {'class': 'summary-item'}).append(
				$("<label>", {'class': 'item-key nowrap'}).html(data.key.replace('/home/kamoru/workspace/FlayOn', '')),
				$("<span>",  {'class': 'item-count badge badge-primary'}).html(data.list.length),
				$("<label>", {'class': 'item-size'}).append(
						(function() {
							var length = 0;
							for (var x in data.list) {
								length += data.list[x].length;
							}
							return File.formatSize(length);
						}())
				)
		).on("click", function() {
			displayFlayList(data.key, data.list);
		}).appendTo($list);
	});	
}

function displayFlayList(key, list) {
	$("#groupByKey").html(key);

	var $flayList = $("#flayList").empty();
	$.each(list, function(idx, flay) {
		$flayList.appendFlayCard(flay, {
			width: 300,
			exclude: [ACTRESS_EXTRA, MODIFIED, RANK, COMMENT, FILEINFO],
			fontSize: '80%'
		});
	});

	$(".flay-list-wrapper").show();
}
</script>