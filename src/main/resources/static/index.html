<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <title>Facade</title>
    <style type="text/css">
      body {
        position: fixed;
        inset: 0;
        margin: 0;
        border: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #202020 url(dist/svg/flayground-text.svg) no-repeat fixed
          center / 300px;
      }
      a {
        width: 300px;
        height: 100px;
      }
    </style>
    <script>
      // ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/service-worker.js")
            .then((registration) => {
              console.log(
                "âœ… [Service Worker] Registered:",
                registration.scope
              );

              // ì¦‰ì‹œ ì—…ë°ì´íŠ¸ ìƒíƒœ ì²´í¬
              if (registration.installing || registration.waiting) {
                // ì´ë¯¸ ì—…ë°ì´íŠ¸ê°€ ì§„í–‰ ì¤‘ì´ê±°ë‚˜ ëŒ€ê¸° ì¤‘
                console.log("ğŸ”„ [Service Worker] Update in progress");
              } else {
                // ì—…ë°ì´íŠ¸ ì—†ìŒ - start íŒŒë¼ë¯¸í„° ì²˜ë¦¬
                checkStartParameter();
              }

              // ì„œë¹„ìŠ¤ ì›Œì»¤ ì—…ë°ì´íŠ¸ ì²´í¬
              registration.addEventListener("updatefound", () => {
                const newWorker = registration.installing;
                if (newWorker) {
                  newWorker.addEventListener("statechange", () => {
                    if (
                      newWorker.state === "installed" &&
                      navigator.serviceWorker.controller
                    ) {
                      console.log("ğŸ”„ [Service Worker] New version available");
                      // ì‚¬ìš©ìì—ê²Œ ì—…ë°ì´íŠ¸ ì•Œë¦¼
                      if (
                        confirm(
                          "ìƒˆë¡œìš´ ë²„ì „ì´ ìˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
                        )
                      ) {
                        newWorker.postMessage({ type: "SKIP_WAITING" });
                        window.location.reload();
                      } else {
                        // ì—…ë°ì´íŠ¸ ê±°ë¶€ ì‹œ start íŒŒë¼ë¯¸í„° ì²´í¬
                        checkStartParameter();
                      }
                    }
                  });
                }
              });
            })
            .catch((error) => {
              console.error("âŒ [Service Worker] Registration failed:", error);
              // ë“±ë¡ ì‹¤íŒ¨ ì‹œì—ë„ start íŒŒë¼ë¯¸í„°ëŠ” ì²˜ë¦¬
              checkStartParameter();
            });

          // ì„œë¹„ìŠ¤ ì›Œì»¤ ì»¨íŠ¸ë¡¤ëŸ¬ ë³€ê²½ ê°ì§€
          navigator.serviceWorker.addEventListener("controllerchange", () => {
            console.log("ğŸ”„ [Service Worker] Controller changed");
            window.location.reload();
          });

          // ì„œë¹„ìŠ¤ ì›Œì»¤ë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹ 
          navigator.serviceWorker.addEventListener("message", (event) => {
            console.log("ğŸ“¬ [Service Worker] Message received:", event.data);

            if (event.data && event.data.type === "NOTIFICATION_CLICK") {
              const data = event.data.data || {};
              console.log("ğŸ”” [Service Worker] Notification clicked:", data);

              // ì•Œë¦¼ í´ë¦­ ì‹œ ì—…ë¬´ íŒì—… ì‹¤í–‰ (ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ ë°œìƒ)
              if (data.action) {
                window.dispatchEvent(
                  new CustomEvent("serviceWorkerNotification", {
                    detail: data,
                  })
                );
              }
            }
          });
        });
      } else {
        // Service Worker ë¯¸ì§€ì› ë¸Œë¼ìš°ì €ëŠ” ë°”ë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜
        checkStartParameter();
      }

      // start íŒŒë¼ë¯¸í„° ì²´í¬ í•¨ìˆ˜
      function checkStartParameter() {
        const urlParams = new URL(location.href).searchParams;
        const start = urlParams.get("start");
        if (start) {
          console.log("ğŸ”— [Navigation] Redirecting to:", start);
          location.href = start;
        }
      }
    </script>
  </head>
  <body>
    <a href="dist/index.html"></a>
  </body>
</html>
