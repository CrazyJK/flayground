<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Flaygound Image path</title>
<link rel="icon" type="image/png" href="/img/favicon/flay_0.png"/>
<link rel="stylesheet" href="/webjars/fontawesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/webjars/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/webjars/jquery-ui/themes/base/jquery-ui.min.css"/>
<link rel="stylesheet" href="/css/crazy.common.css"/>
<link rel="stylesheet" href="/css/flay.notification.css"/>
<style type="text/css">
body {
	overflow: hidden;
}
#controlBox {
	position: fixed;
	bottom: 0;
	right: 0;
	padding: .25rem;
	opacity: 0;
}
#controlBox:hover {
	opacity: 1;
}
input:focus, button:focus {
	box-shadow: none !important;
}
.btn-dark:disabled {
	color: gray;
}
#pathContainer {
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	display: none;
}
#closePathContainer {
    position: absolute;
    right: 0;
    bottom: 0;
    margin: 1rem;
}
</style>
<script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/webjars/popper.js/umd/popper.js"></script>
<script type="text/javascript" src="/webjars/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/webjars/jquery-ui/jquery-ui.min.js"></script>
<script type="text/javascript" src="/js/crazy.common.js"></script>
<script type="text/javascript" src="/js/crazy.jquery.js"></script>
<script type="text/javascript" src="/js/flay.rest.service.js"></script>
<script type="text/javascript" src="/js/flay.utils.js"></script>
<script type="text/javascript" src="/js/flay.notification.js"></script>
<script type="text/javascript" src="/js/tag/jquery.tagcanvas.js"></script>
<script type="text/javascript">

var ImageControl = {
		STORAGE_IMAGE_SIZE: 'image.cloud.image_size',
		STORAGE_PLAY_TIME: 'image.cloud.play_time',
		imageIndexArray: [],
		dataArray: [],
		bgInterval: null,
		count: 0,
		isStart: false,
		intervalCount: 0,
		init: function() {
			restCall('/image/group/path', {}, function(map) {
				map['ALL'] = [];
				$.each(map, function(k, v) {
					var pathName = k.replace(/\\/gi, '/').split("/").pop();
					$("<label>", {'class': 'input dark', id: 'path_' + pathName}).append(
							$("<input>", {type: 'radio', name: 'path'}).on("change", function(e) {
								ImageControl.setData(k, v);
							}),
							$("<span>").append(
									pathName,
									$("<span>", {'class': 'badge badge-fill badge-secondary text-dark ml-2'}).html(v.length)
							)
					).appendTo($("#paths"));
				});
				Rest.Image.size(function(count) {
					ImageControl.count = count;
					$("#path_ALL span.badge").html(count);
					$("#path_ALL").click();
				});
			});
			
			ImageControl.ImageCanvas.resize();
			ImageControl.bgInterval = setInterval(ImageControl.func, 1000);
			ImageControl.nav();
			ImageControl.ImageCanvas.start();
			
		},
		setData: function(path, array) {
			$("#selectedPath").html(path);
			ImageControl.dataArray = array.slice();
			ImageControl.imageIndexArray = array.slice();
			ImageControl.display();
		},
		nav: function() {
			$("#canvasContainer").navEvent(function(signal, e) {
				switch(signal) {
				case 32: // key: space
					ImageControl.ImageCanvas.rotate();
					break;
				case 34: // key: pageDown 	
					ImageControl.display();
					break;
				}
			});
		},
		play: function() {
			ImageControl.intervalCount = 0;
			ImageControl.isStart = true;
		},
		stop: function() {
			$(".progress-bar").css({width: "100%"});
			ImageControl.isStart = false;
		},
		func: function() {
			if (ImageControl.isStart) {
				ImageControl.intervalCount = ++ImageControl.intervalCount % parseInt(inputPlayTime.value);
				$(".progress-bar").css({
					width: (100 - Math.round(ImageControl.intervalCount / parseInt(inputPlayTime.value) * 100)) + "%"
				});
				
				if (ImageControl.intervalCount == 0) {
					ImageControl.display();
				}
			}
		},
		display: function() {
			if (ImageControl.ImageCanvas.status === 'pause') {
				return;
			}
			// make image index array
			if (ImageControl.imageIndexArray.length === 0) {
				if (ImageControl.dataArray.length > 0)
					ImageControl.imageIndexArray = ImageControl.dataArray; 
				else
					ImageControl.imageIndexArray = Array.apply(null, {length: ImageControl.count}).map(Number.call, Number);

				console.log('image array reset', ImageControl.imageIndexArray.length, ImageControl.dataArray.length);
			}

			var $imageWrap = $("#imagePane").empty();

			for (var i=0; i<inputImageSize.value; i++) {
				// determine image index
				var imageIndex = ImageControl.imageIndexArray.splice(Random.getInteger(0, ImageControl.imageIndexArray.length-1), 1);
				if ($.isEmptyObject(imageIndex)) {
					// console.log('imageIndex is empty', ImageControl.imageIndexArray.length, imageIndex);
				} else {
					$("<a>").attr({
						"id": "image" + i,
						"data-idx": imageIndex
					}).append(
							$("<img>").attr({
								src: PATH + "/static/image/" + imageIndex
							})
					).on("click", function(e) {
						e.preventDefault();
						Popup.imageByNo($(this).attr("data-idx"));
					}).appendTo($imageWrap);
				}
			}
			
			$(".image-info").html("Remaining " + ImageControl.imageIndexArray.length);
			
			ImageControl.ImageCanvas.reload();
		},
		ImageCanvas: {
			options: {
				clickToFront: 300,
				depth: 0.9,
				fadeIn: 500,
				hideTags: true,
				imageMode: 'image',
				imageRadius: 4,
				imageScale: 0.3,
				imageWidth: 400,
				imageHeight: 0,
				initial: [0.1, -0.1],
				maxSpeed: 0.03,
				minBrightness: 0.3,
				minSpeed: 0.003,
				outlineMethod: 'none',
				reverse: true,
				noTagsMessage: false
			},
			status: '',
			start: function() {
				$('#imageCloud').tagcanvas(ImageControl.ImageCanvas.options, 'imagePane');
			},
			update: function() {
				$('#imageCloud').tagcanvas('update');
			},
			reload: function() {
				$('#imageCloud').tagcanvas('reload');
			},
			rotate: function() {
				if (ImageControl.ImageCanvas.status != 'pause') {
					$('#imageCloud').tagcanvas('rotatetag', {id: "image" + Random.getInteger(0, inputImageSize.value - 1), lat: 0, lng: 0});
				}
			},
			pause: function() {
				$('#imageCloud').tagcanvas('pause');
				ImageControl.ImageCanvas.status = 'pause';
			},
			resume: function() {
				$('#imageCloud').tagcanvas('resume');
				ImageControl.ImageCanvas.status = 'resume';
			},
			resize: function() {
				$('#imageCloud').attr({
					width: $(window).width(),
					height: $(window).height()
				});
			}
		}
};

$(document).ready(function() {
	
	inputImageSize.value = LocalStorageItem.getInteger(ImageControl.STORAGE_IMAGE_SIZE, 20);
	inputPlayTime.value  = LocalStorageItem.getInteger(ImageControl.STORAGE_PLAY_TIME, 30);
	
	setTimeout(function() {
		$(window).on("resize", ImageControl.ImageCanvas.resize);
	}, 5000);
	
	$("#btnRotate").on("click", ImageControl.ImageCanvas.rotate);
	$("#btnPause").on("click", function() {
		console.log('$(this).data("status")', $(this).data("status"));
		if ($(this).data("status") === 'resume') {
			ImageControl.ImageCanvas.pause();
			$(this).data("status", "pause").html('<i class="fa fa-play"></i> Resume');
			$("#btnPlay, #btnNext, #btnRotate").prop('disabled', true);
		} else {
			ImageControl.ImageCanvas.resume();
			$(this).data("status", "resume").html('<i class="fa fa-pause"></i> Pause');
			$("#btnPlay, #btnNext, #btnRotate").prop('disabled', false);
		}
	});
	$("#btnNext").on("click", ImageControl.display);
	$("#btnPlay").on("click", function() {
		if ($(this).data("status") === 'stop') {
			ImageControl.play();
			$(this).data("status", "start").html('<i class="fa fa-stop"></i> Stop');
			$("#btnPause").prop('disabled', true);
		} else {
			ImageControl.stop();
			$(this).data("status", "stop").html('<i class="fa fa-play"></i> Play');
			$("#btnPause").prop('disabled', false);
		}
	});
	$("#inputImageSize").on("change", function() {
		LocalStorageItem.set(ImageControl.STORAGE_IMAGE_SIZE, $(this).val());
	});
	$("#inputPlayTime").on("change", function() {
		LocalStorageItem.set(ImageControl.STORAGE_PLAY_TIME, $(this).val());
	});
	$("#goFlay").on("click", function() {
		location.href = PATH + "/html/flay/flay.index.html";
	});
	$("#selectedPath").on("click", function() {
		var path = $(this).html();
		if (path != 'ALL')
			Rest.Flay.openFolder(path);
	});
	$("#btnByPath").on("click", function() {
		$("#pathContainer").slideToggle();
	});
	$("#closePathContainer").on("click", function() {
		$("#pathContainer").slideToggle();
	});
	
	ImageControl.init();

});

</script>
</head>
<body>

<div class="text-center p-3 bg-dark" id="pathContainer">
	<div id="paths"></div>
	<label id="selectedPath" class="text hover dark mt-1"></label>
	<i class="fa fa-times hover" id="closePathContainer"></i>
</div>

<div id="canvasContainer">
	<canvas id="imageCloud" width="800" height="600"></canvas>
	<div id="imagePane" style="display: none;"></div>
</div>

<div id="controlBox">
	<div class="input-group input-group-sm">
		<div class="input-group-prepend">
			<button class="btn btn-dark" id="btnByPath"><i class="fa fa-bars"></i> By path</button>
			<span class="input-group-text border-dark bg-dark text-light image-info">0</span>
			<button class="btn btn-dark" id="btnRotate"><i class="fa fa-random"></i> Rotate</button>
			<button class="btn btn-dark" id="btnPause" data-status="resume"><i class="fa fa-pause"></i> Pause</button>
		</div>
		<input class="form-control border-dark bg-dark text-light text-right" id="inputImageSize" style="width: 40px;" value="10" title="Image size">
		<div class="input-group-append">
    		<button class="btn btn-dark" id="btnNext"><i class="fa fa-forward"></i> Next</button>
  		</div>
		<input class="form-control border-dark bg-dark text-light text-right" id="inputPlayTime" style="width: 40px;" value="60" title="Play seconds">
		<div class="input-group-append">
    		<button class="btn btn-dark" id="btnPlay" data-status="stop"><i class="fa fa-play"></i> Play</button>
    		<button class="btn btn-dark" id="goFlay" title="go Flay"><i class="fa fa-file-video-o"></i></button>
  		</div>
	</div>
	<div class="progress" style="height: 1px; margin: 0 3px;">
  		<div class="progress-bar bg-dark" style="width:100%"></div>
	</div>
</div>

</body>
</html>