<style type="text/css">
.studio {
	max-width: 150px;
}
.opus {
	max-width: 100px;
}
.title {
	max-width: 610px;
}
.actress {
	max-width: 150px;
}
.release {
	max-width: 100px;
}
@media (min-width: 992px) {
	.title {
		max-width: 430px;
	}
}
@media (min-width: 768px) {
	.studio {
		max-width: 100px;
	}
	.title {
	    max-width: 290px;
	}
	.actress {
		max-width: 100px;
	}
	.release {
		max-width: 100px;
	}
}

.flay-info {
	color: var(--light);
	text-shadow: 1px 1px 4px var(--dark);
}
#detailView {
	position: relative;
	display: none;
	background-color: rgba(0,0,0,.5);
	border: 1px solid rgba(255,255,255,.5);
}

.marker-direction {
    position: absolute;
    top: 150px;
    font-size: 200px;
    cursor: pointer;
    transition: color .3s;
}
.marker-direction:hover {
	color: rgba(248, 249, 250, .5);
}
.marker-previous {
    left: 10px;
}
.marker-next {
    right: 10px;
}
</style>

<div class="fixed-top bg-light p-2">
	<div class="container">
		<div class="row">
			<div class="col-3">
				<div class="input-group">
					<input type="text" class="form-control border-light bg-light" id="keyword" placeholder="Search">
					<div class="input-group-append">
						<span class="input-group-text bg-light border-light" id="totalFlayCount"></span>
					</div>
				</div>
			</div>
			<div class="col-6">
	  			<ul class="pagination justify-content-center m-0">
	    			<li class="page-item" id="page-first"><a class="page-link" href="javascript:goPage('first');"><i class="fa fa-fast-backward"></i></a></li>
	    			<li class="page-item" id="page-prev"><a class="page-link" href="javascript:goPage('prev');"><i class="fa fa-backward"></i></a></li>
	    			<li class="page-item" id="page-next"><a class="page-link" href="javascript:goPage('next');"><i class="fa fa-forward"></i></a></li>
	    			<li class="page-item" id="page-last"><a class="page-link" href="javascript:goPage('last');"><i class="fa fa-fast-forward"></i></a></li>
	  			</ul>
			</div>
			<div class="col-3">
				<div class="input-group">
					<input type="number" class="form-control border-light bg-light text-right" id="pageSize">
					<div class="input-group-append">
			  			<button type="button" class="btn btn-flay border-light btn-view-type" data-type="table"><i class="fa fa-list"></i></button>
			  			<button type="button" class="btn btn-flay border-light btn-view-type" data-type="card" ><i class="fa fa-th"></i></button>
					</div>		
				</div>		
			</div>
		</div>
	</div>
</div>

<div id="contentWrapper">

	<div class="container rounded p-2 mb-4" id="detailView">
		<div class="text-right">
			<i class="fa fa-times text-dark mx-2 hover" id="btnCloseDetailView"></i>
		</div>
		<div class="marker-direction marker-previous"><i class="fa fa-angle-left"></i></div>
		<div class="marker-direction marker-next"><i class="fa fa-angle-right"></i></div>
		<div class="mx-auto mb-4" id="detailViewInner"></div>
	</div>

	<div class="container" id="tableView">
		<div class="rounded bg-light p-1">
			<table class="table table-sm table-hover bg-light m-0">
				<thead>
					<tr>
						<th class="border-top-0 studio">Studio</th>
						<th class="border-top-0 opus">Opus</th>
						<th class="border-top-0 title">Title</th>
						<th class="border-top-0 actress">Actress</th>
						<th class="border-top-0 release">Release</th>
					</tr>
				</thead>
				<tbody id="tableList"></tbody>
			</table>
		</div>
	</div>
	<div class="container-fluid" id="cardView">
		<div id="cardList" class="text-center"></div>
	</div>	
</div>
	
<div class="fixed-bottom bg-light p-2">
	<div class="container">
		<ul class="pagination justify-content-center m-0">
			<li class="page-item"><a class="page-link" href="javascript:goPage()" id="page_1">1</a></li>
			<li class="page-item"><a class="page-link" href="javascript:goPage()" id="page_2">2</a></li>
			<li class="page-item"><a class="page-link" href="javascript:goPage()" id="page_3">3</a></li>
			<li class="page-item"><a class="page-link" href="javascript:goPage()" id="page_4">4</a></li>
			<li class="page-item"><a class="page-link" href="javascript:goPage()" id="page_5">5</a></li>
			<li class="page-item"><a class="page-link" href="javascript:goPage()" id="page_6">6</a></li>
			<li class="page-item"><a class="page-link" href="javascript:goPage()" id="page_7">7</a></li>
			<li class="page-item"><a class="page-link" href="javascript:goPage()" id="page_8">8</a></li>
			<li class="page-item"><a class="page-link" href="javascript:goPage()" id="page_9">9</a></li>
			<li class="page-item"><a class="page-link" href="javascript:goPage()" id="page_10">10</a></li>
		</ul>
	</div>
</div>
	
<script type="text/javascript">
var FLAY_ARCHIVE_VIEWTYPE = 'flay.archive.viewType';
var FLAY_ARCHIVE_PAGESIZE = 'flay.archive.pageSize';
var pageNo = 0, keyword, total = 0,
	size = LocalStorageItem.getInteger(FLAY_ARCHIVE_PAGESIZE, 15), 
	viewType = LocalStorageItem.get(FLAY_ARCHIVE_VIEWTYPE, 'table');
var flayList = [];

function addEventListener() {
	$("#pageSize").val(size).on("keyup", function(e) {
		if (e.keyCode != 13)
			return;
		LocalStorageItem.set(FLAY_ARCHIVE_PAGESIZE, $(this).val());
		showDetail('off');
		goPage('current');
	});

	$(".btn-view-type").on("click", function() {
		viewType = $(this).data("type");
		if (viewType === 'table') {
			$("#tableView").show();
			$("#cardView").hide();
		} else if (viewType === 'card') {
			$("#tableView").hide();
			$("#cardView").show();
		}
		LocalStorageItem.set(FLAY_ARCHIVE_VIEWTYPE, viewType);
		showDetail('off');
		goPage('current');
	});

	$("#btnCloseDetailView").on("click", function() {
		showDetail('off');
	});

	$("#keyword").on("keyup", function(e) {
		if (e.keyCode === 13)
			goPage(1);
	});

	$(".marker-previous").on("click", function() {
		var idx = $("#detailViewInner").data("idx");
		showDetail(--idx);
	});
	$(".marker-next").on("click", function() {
		var idx = $("#detailViewInner").data("idx");
		showDetail(++idx);
	});

	$(window).on("resize", function() {
		var windowHeight = $(window).height();
		var    topHeight = $(".fixed-top").height() + 16 + 8;
		var bottomHeight = $(".fixed-bottom").height() + 16 + 8;

		$("#contentWrapper").css({
			height: windowHeight - topHeight - bottomHeight,
			marginTop: topHeight,
			overflow: 'auto'
		});
	}).trigger('resize');	
}

function goPage(p) {
	if (typeof p === 'string') {
		if (p === 'first')
			pageNo = 0;
		else if (p === 'prev')
			--pageNo;
		else if (p === 'next')
			++pageNo;
		else if (p === 'last')
			pageNo = total - 1;
	} else {
		pageNo = p - 1;
	}
	
	pageNo = Math.max(pageNo, 0);
	size = $("#pageSize").val();
	keyword = $("#keyword").val();

	Rest.Archive.page(pageNo, size, keyword, function(page) {
		flayList = page.content;
		
		showDetail('off');
		if (viewType === 'table') {
			displayTable();
		} else if (viewType === 'card') {
			displayCard();
		}

		$("#totalFlayCount").html(page.totalElements);
		pagination(page);
	});
	
	function displayTable() {
		var $tableList = $("#tableList");
		$tableList.empty();
		$.each(flayList, function(idx, flay) {
			$("<tr>").append(
					$("<td>", {'class': 'nowrap studio'}).html(flay.studio),
					$("<td>", {'class': 'nowrap opus'}).html(flay.opus),
					$("<td>", {'class': 'nowrap title'}).append(
							$("<i>", {'class': 'fa fa-file-video-o mx-1'}).addClass(flay.files.movie.length > 0 ? "" : "text-light"),
							$("<i>", {'class': 'fa fa-file-image-o mx-1'}).addClass(flay.files.cover.length > 0 ? "" : "text-light"),
							$("<i>", {'class': 'fa fa-file-text-o mx-1'}).addClass(flay.files.subtitles.length > 0 ? "" : "text-light"),
							$("<span>", {'class': 'hover'}).html(flay.title).on("click", function() {
								showDetail(idx);
							})
					),
					$("<td>", {'class': 'nowrap actress'}).html(flay.actressList.toString()),
					$("<td>", {'class': 'nowrap release'}).html(flay.release),
			).appendTo($tableList);
		});
	}
	
	function displayCard() {
		var $cardList = $("#cardList");
		$cardList.empty();
		$.each(flayList, function(idx, flay) {
			$("<div>", {'class': 'card m-2'}).css({
				display: 'inline-block',
				width: 300,
			}).append(
					$("<img>", {'class': 'card-img-top', 'src': '/static/cover/' + flay.opus}).css({
						width: 298,
						height: Math.round(298 * COVER_RATIO),
					}),
					$("<div>", {'class': 'card-body bg-dark p-2'}).css({
						borderBottomLeftRadius: 4,
						borderBottomRightRadius: 4
					}).append(
							$("<h5>", {'class': 'card-title flay-info nowrap hover m-0', title: flay.title}).html(flay.title).on("click", function() {
								showDetail(idx);
							}),
							$("<p>", {'class': 'card-text flay-info nowrap'}).css({
								minHeight: 24
							}).html(flay.actressList.toString())
					)
			).appendTo($cardList);
		});
	}
	
	function pagination(page) {
		pageNo = page.number;
		total = page.totalPages;
		var base = Math.floor(page.number / 10) * 10;
		var start = base + 1, end = Math.min(base + 10, page.totalPages);
		
		for (var i = 1; i <= 10; ++i) {
			$("#page_" + i).attr("href", "javascript:goPage(" + start + ")").html(start)
				.parent().removeClass("active disabled");
			if (start - 1 == pageNo) {
				$("#page_" + i).parent().addClass("active");
			}
			if (start > total) {
				$("#page_" + i).parent().addClass("disabled");
			}
			++start;
		}
		
		if (page.first) {
			$("#page-first, #page-prev").addClass("disabled");
		} else {
			$("#page-first, #page-prev").removeClass("disabled");
		}

		if (page.last) {
			$("#page-next, #page-last").addClass("disabled");
		} else {
			$("#page-next, #page-last").removeClass("disabled");
		}
	}
}

function showDetail(idx) {
	if (typeof idx === 'string' && idx === 'off') {
		$("#detailView").slideUp();
	} else if (typeof idx === 'number') {
		var flay = flayList[idx];
		if (flay) {
			$("#detailViewInner").data("idx", idx).empty().appendFlayCard(flay);
			$("#detailView").slideDown();
		}
	}
}

addEventListener();
$("button.btn-view-type[data-type='" + viewType + "']").click();

</script>
