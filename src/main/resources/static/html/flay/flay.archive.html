<style type="text/css">
.studio {
	max-width: 150px;
}
.opus {
	max-width: 100px;
}
.title {
	max-width: 610px;
}
.actress {
	max-width: 150px;
}
.release {
	max-width: 100px;
}
@media (min-width: 992px) {
	.title {
		max-width: 430px;
	}
}
@media (min-width: 768px) {
	.studio {
		max-width: 100px;
	}
	.title {
	    max-width: 290px;
	}
	.actress {
		max-width: 100px;
	}
	.release {
		max-width: 100px;
	}
}

.flay-info {
	color: var(--light);
	text-shadow: 1px 1px 4px var(--dark);
}
#detailView {
	display: none;
	background-color: rgba(0,0,0,.5);
	border: 1px solid rgba(255,255,255,.5);
}
</style>

<div class="fixed-top bg-light p-2">
	<div class="container">
		<div class="row">
			<div class="col-4">
				<div class="btn-group">
		  			<button type="button" class="btn btn-light btn-view-type" data-type="table"><i class="fa fa-list"></i></button>
		  			<button type="button" class="btn btn-light btn-view-type" data-type="card" ><i class="fa fa-th"></i></button>
				</div>		
			</div>
			<div class="col-4">
	  			<ul class="pagination justify-content-center m-0">
	    			<li class="page-item" id="page-first"><a class="page-link" href="javascript:go('first');"><i class="fa fa-fast-backward"></i></a></li>
	    			<li class="page-item" id="page-prev"><a class="page-link" href="javascript:go('prev');"><i class="fa fa-backward"></i></a></li>
	    			<li class="page-item" id="page-next"><a class="page-link" href="javascript:go('next');"><i class="fa fa-forward"></i></a></li>
	    			<li class="page-item" id="page-last"><a class="page-link" href="javascript:go('last');"><i class="fa fa-fast-forward"></i></a></li>
	  			</ul>
			</div>
			<div class="col-4">
				<div class="input-group">
					<select id="pageSize" class="custom-select border-primary" style="max-width: 70px;">
			    		<option value="10">10</option>
			    		<option value="15">15</option>
			    		<option value="20">20</option>
			    		<option value="30">30</option>
			    		<option value="50">50</option>
			  		</select>
					<input type="text" class="form-control border-primary" id="keyword" placeholder="Keyword">
					<div class="input-group-append">
						<button class="btn btn-outline-primary" id="btnGo">Go</button> 
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div id="contentWrapper">

	<div class="container rounded p-2" id="detailView">
		<div class="text-right">
			<i class="fa fa-times text-danger mx-2 hover" id="btnCloseDetailView"></i>
		</div>
		<div class="mx-auto mb-4" id="detailViewInner">
		</div>
	</div>

	<div class="container" id="tableView">
		<div class="rounded bg-light p-1">
			<table class="table table-sm table-hover bg-light m-0">
				<thead>
					<tr>
						<th class="border-top-0 studio">Studio</th>
						<th class="border-top-0 opus">Opus</th>
						<th class="border-top-0 title">Title</th>
						<th class="border-top-0 actress">Actress</th>
						<th class="border-top-0 release">Release</th>
					</tr>
				</thead>
				<tbody id="tableList">
				</tbody>
			</table>
		</div>
	</div>
	<div class="container-fluid" id="cardView">
		<div id="cardList" class="text-center"></div>
	</div>	
</div>
	
<div class="fixed-bottom bg-light p-2">
	<div class="container">
		<ul class="pagination justify-content-center m-0">
			<li class="page-item"><a class="page-link" href="javascript:go()" id="page_1">1</a></li>
			<li class="page-item"><a class="page-link" href="javascript:go()" id="page_2">2</a></li>
			<li class="page-item"><a class="page-link" href="javascript:go()" id="page_3">3</a></li>
			<li class="page-item"><a class="page-link" href="javascript:go()" id="page_4">4</a></li>
			<li class="page-item"><a class="page-link" href="javascript:go()" id="page_5">5</a></li>
			<li class="page-item"><a class="page-link" href="javascript:go()" id="page_6">6</a></li>
			<li class="page-item"><a class="page-link" href="javascript:go()" id="page_7">7</a></li>
			<li class="page-item"><a class="page-link" href="javascript:go()" id="page_8">8</a></li>
			<li class="page-item"><a class="page-link" href="javascript:go()" id="page_9">9</a></li>
			<li class="page-item"><a class="page-link" href="javascript:go()" id="page_10">10</a></li>
		</ul>
	</div>
</div>
	
<script type="text/javascript">
var FLAY_ARCHIVE_VIEWTYPE = 'flay.archive.viewType';
var FLAY_ARCHIVE_PAGESIZE = 'flay.archive.pageSize';
var pageNo = 0, keyword, total = 0,
	size = LocalStorageItem.getInteger(FLAY_ARCHIVE_PAGESIZE, 15), 
	viewType = LocalStorageItem.get(FLAY_ARCHIVE_VIEWTYPE, 'table');

$("#pageSize").val(size).prop("selected", true).on("change", function() {
	LocalStorageItem.set(FLAY_ARCHIVE_PAGESIZE, $(this).val());
	showDetail('off');
	go('current');
});

$(".btn-view-type").on("click", function() {
	viewType = $(this).data("type");
	if (viewType === 'table') {
		$("#tableView").show();
		$("#cardView").hide();
	} else if (viewType === 'card') {
		$("#tableView").hide();
		$("#cardView").show();
	}
	LocalStorageItem.set(FLAY_ARCHIVE_VIEWTYPE, viewType);
	showDetail('off');
	go('current');
});

$("#btnCloseDetailView").on("click", function() {
	showDetail('off');
});

$("#btnGo").on("click", function() {
	go(1);
});

$(window).on("resize", function() {
	$("#contentWrapper").css({
		height: $(window).height() - 16*6,
		marginTop: $(".fixed-top").height() + 16,
		overflow: 'scroll'
	}).height();
}).trigger("resize");

function go(p) {
	if (typeof p === 'string') {
		if (p === 'first')
			pageNo = 0;
		else if (p === 'prev')
			--pageNo;
		else if (p === 'next')
			++pageNo;
		else if (p === 'last')
			pageNo = total - 1;
	} else {
		pageNo = p - 1;
	}
	
	if (pageNo < 0)
		pageNo = 0;
	
	size = $("#pageSize").val();
	keyword = $("#keyword").val();
	
	var $tableList = $("#tableList");
	var $cardList = $("#cardList");
	Rest.Flay.archive(pageNo, size, keyword, function(page) {
		if (viewType === 'table') {
			$tableList.empty();
			$.each(page.content, function(idx, flay) {
				$("<tr>").append(
						$("<td>", {'class': 'nowrap studio'}).html(flay.studio),
						$("<td>", {'class': 'nowrap opus'}).html(flay.opus),
						$("<td>", {'class': 'nowrap title hover'}).html(flay.title).on("click", function() {
							showDetail(flay);
						}),
						$("<td>", {'class': 'nowrap actress'}).html(flay.actressList.toString()),
						$("<td>", {'class': 'nowrap release'}).html(flay.release),
				).appendTo($tableList);
			});
		} else if (viewType === 'card') {
			$cardList.empty();
			$.each(page.content, function(idx, flay) {
				$("<div>", {'class': 'card m-2 hover'}).css({
					display: 'inline-block',
					width: 300,
				}).append(
						$("<img>", {'class': 'card-img-top', 'src': '/static/cover/' + flay.opus}).css({
							width: 298,
							height: Math.round(298 * COVER_RATIO),
						}),
						$("<div>", {'class': 'card-body bg-dark p-2'}).css({
							borderBottomLeftRadius: 4,
    						borderBottomRightRadius: 4
						}).append(
								$("<h5>", {'class': 'card-title flay-info nowrap m-0', title: flay.title}).html(flay.title),
								$("<p>", {'class': 'card-text flay-info nowrap'}).css({
									minHeight: 24
								}).html(flay.actressList.toString())
						)
				).on("click", function() {
					showDetail(flay);
				}).appendTo($cardList);
			});
		}
		
		pageNo = page.number;
		total = page.totalPages;
		var base = Math.floor(page.number / 10) * 10;
		var start = base + 1, end = Math.min(base + 10, page.totalPages);
		
		for (var i = 1; i <= 10; ++i) {
			$("#page_" + i).attr("href", "javascript:go(" + start + ")").html(start)
				.parent().removeClass("active disabled");
			if (start - 1 == pageNo) {
				$("#page_" + i).parent().addClass("active");
			}
			if (start > total) {
				$("#page_" + i).parent().addClass("disabled");
			}
			++start;
		}
		
		if (page.first) {
			$("#page-first, #page-prev").addClass("disabled");
		} else {
			$("#page-first, #page-prev").removeClass("disabled");
		}

		if (page.last) {
			$("#page-next, #page-last").addClass("disabled");
		} else {
			$("#page-next, #page-last").removeClass("disabled");
		}

	});
}

function showDetail(flay) {
	if (typeof flay === 'string' && flay === 'off') {
		$("#detailView").slideUp();
	} else {
		$("#detailViewInner").empty().appendFlayCard(flay);
		$("#detailView").slideDown();
	}
}

$("button.btn-view-type[data-type='" + viewType + "']").click();

</script>
