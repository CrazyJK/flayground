<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Flay History Chart</title>
		<link rel="stylesheet" href="/webjars/bootstrap/css/bootstrap.min.css" />
		<style type="text/css">
			body {
				background-color: #000;
			}
			#chartdiv {
				width: 100%;
				height: 100vh;
			}
		</style>
	</head>
	<body>
		<div class="container-fluid">
			<div id="chartdiv"></div>
		</div>

		<script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
		<script type="text/javascript" src="/webjars/popper.js/umd/popper.js"></script>
		<script type="text/javascript" src="/webjars/bootstrap/js/bootstrap.min.js"></script>
		<script type="text/javascript" src="/webjars/amcharts/amcharts.js"></script>
		<script type="text/javascript" src="/webjars/amcharts/serial.js"></script>
		<script type="text/javascript" src="/webjars/amcharts/themes/black.js"></script>
		<script type="text/javascript" src="/webjars/amcharts/lang/ko.js"></script>
		<script type="text/javascript" src="../../js/crazy.common.js"></script>
		<script type="text/javascript" src="../../js/flay.rest.service.js"></script>
		<script type="text/javascript">
			const opus = reqParam.opus;
			const firstDayOfThisYear = AmCharts.stringToDate(DateUtils.format("yyyy-01-01"), "YYYY-MM-DD");
			// const firstDayOfThisYear = AmCharts.stringToDate("2013-01-01", "YYYY-MM-DD");

			Rest.History.find(opus, (histories) => {
				document.title = opus + " " + document.title;
				drawGraph(histories);
			});

			function drawGraph(historyList) {
				let playMap = {};
				let deleteMap = {};
				playMap[DateUtils.format("yyyy-MM-dd HH:mm:ss")] = [];
				$.each(historyList, function (idx, history) {
					const key = history.date.substring(0, 10);
					if (history.action === "PLAY") {
						if (playMap[key]) {
							playMap[key].push(history);
						} else {
							playMap[key] = [history];
						}
					} else if (history.action === "DELETE") {
						if (deleteMap[key]) {
							deleteMap[key].push(history);
						} else {
							deleteMap[key] = [history];
						}
					}
					console.log(`${history.id} : ${history.date} - ${history.action}`);
				});
				// console.log("Map", playMap, deleteMap);

				let playArray = [];
				$.each(playMap, function (key, val) {
					playArray.push({
						date: AmCharts.stringToDate(key, "YYYY-MM-DD"),
						playCount: val.length,
					});
				});

				let deleteArray = [];
				$.each(deleteMap, function (key, val) {
					deleteArray.push({
						date: AmCharts.stringToDate(key, "YYYY-MM-DD"),
						deleteCount: val.length,
					});
				});

				const dataArray = [...playArray, ...deleteArray];
				dataArray.sort(function (d1, d2) {
					return d1.date > d2.date ? 1 : -1;
				});
				if (dataArray[0].date.getTime() > firstDayOfThisYear.getTime()) {
					dataArray.unshift({
						date: firstDayOfThisYear,
						playCount: 0,
					});
				}

				AmCharts.makeChart("chartdiv", {
					type: "serial",
					theme: "black",
					dataProvider: dataArray,
					language: "ko",
					graphs: [
						{
							id: "playGraph",
							type: "column",
							valueField: "playCount",
							fillColors: "#FFFF00",
							fillAlphas: 0.8,
							lineAlpha: 0,
							balloonText: "<b>[[value]]</b> <small>play</small>",
							balloon: {
								drop: true,
							},
						},
						{
							id: "deleteGraph",
							type: "column",
							valueField: "deleteCount",
							fillColors: "#FF0000",
							fillAlphas: 0.8,
							lineAlpha: 0,
							balloonText: "<b>delete</b>",
							balloon: {
								drop: true,
							},
						},
					],
					chartCursor: {
						// limitToGraph: "playCount",
						categoryBalloonDateFormat: "YYYY-MM-DD",
					},
					valueAxes: [
						{
							gridAlpha: 0.2,
							dashLength: 1,
						},
					],
					categoryField: "date",
					categoryAxis: {
						parseDates: true,
					},
				});
			}
		</script>
	</body>
</html>
