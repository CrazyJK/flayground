<!DOCTYPE html>
<html>
<head>
<title>Image view</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" type="image/png" href="/img/favicon/flay_2.png"/>
<link rel="stylesheet" href="/webjars/fontawesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/crazy.common.css"/>
<style type="text/css">
body {
	background: #000;
	overflow: hidden;
	margin: 0;
}

.img-magnifier-container {
  	position: relative;
}
.img-magnifier-glass {
  	position: absolute;
	background-repeat: no-repeat;
  	border: 0;
  	border-radius: 50%;
  	cursor: none;
  	opacity: 0;
  	display: none;
  	left: 0;
  	bottom: 0;
	box-shadow: 0 0 4px 2px rgba(255, 255, 255, .25), 0 0 16px 8px rgba(0, 0, 0, .75) inset;
}
.img-magnifier-container:hover .img-magnifier-glass {
	opacity: 1;
}

img.img-responsive {
	max-width: 100%;
	max-height: 100%;
}

.overlay {
	opacity: 0;
	transition: .5s;
}
.overlay:hover {
  	opacity: 1;
}

#info {
	position: fixed;
	bottom: 0;
	right: 0;
	margin: 0;
	padding: 4px;
	background-color: rgba(0, 0, 0, .5);
	border-top-left-radius: 4px;
	cursor: default;
	text-align: right;
}
#info > label {
	display: inline-block;
	margin: 2px;
	color: #eee;
	font-size: 14px;
	text-shadow: 1px 1px 2px #111;
	transition: .3s;
}
#info > label:empty {
	display: none;
}
#info > #magnifier:hover, #info > #path:hover, #info > #paint:hover {
    cursor: pointer;
    color: OrangeRed;
    text-shadow: 1px 1px 2px #2d2d2d;
}
#info > #iname {
	color: yellow;
}
#info > #size, #info > #length, #info > #lastModified {
	font-size: 80%;
}
#info > #moveOut, #info > #paint {
	display: none;
}
#info > #moveOut:hover {
    cursor: pointer;
	color: #dc3545;
    text-shadow: 1px 1px 2px #2d2d2d;
}
i.fa {
	margin: 0 4px;
}
input[type='number'] {
	background: transparent;
	border: 0;
	color: #eee;
	margin: 0;
	padding: 0;
}
#sIze {
	width: 40px;
}
#zOOm {
	width: 25px;
}
</style>
<script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/js/crazy.common.js"></script>
<script type="text/javascript" src="/js/flay.rest.service.js"></script>
<script type="text/javascript" src="/js/flay.utils.js"></script>
<script type="text/javascript">
$(document).ready(function() {
	app();

	sIze.value = LocalStorageItem.get('image.magnifier.size', 200);
	zOOm.value = LocalStorageItem.get('image.magnifier.zoom', 2);
	
	$("#sIze, #zOOm").on("change", function() {
		LocalStorageItem.set('image.magnifier.size', sIze.value);
		LocalStorageItem.set('image.magnifier.zoom', zOOm.value);
	});
});

var app = function() {
	// parameter
	var no  = reqParam.no;
	var src = reqParam.src;
	var imgSrc = no ? PATH + '/static/image/' + no : src;
	var $glass, bw = 3;
	
	// get image
	var img = new Image();
	img.onload = function() {
		// popup resize
 		var browserMargin = getBrowserMargin();
  		window.resizeTo(this.naturalWidth + browserMargin.width, this.naturalHeight + browserMargin.height);

  		$("#image").attr({
			'src': this.src
		}).on("click", function() { 
			$(this).toggleClass('img-responsive');
		});
  		
		$glass = $("#glass").css({
			backgroundImage: "url('" + this.src + "')"
		});

  		// show default info
		$("#size").html(this.naturalWidth + ' x ' + this.naturalHeight);
		
  		// magnifier glass toggle
  		var onOff = 0;
  		$("#magnifier").on("click", function() {
  			if (onOff++ % 2 === 0) {
  				$("#image, #glass").on("mousemove", function(e) {
  					moveMagnifier(e);
  				});
  				$glass.show();
  			} else {
  				$("#image, #glass").off("mousemove");
  				$glass.hide();
  			}
        });
	};
	img.src = imgSrc;

	// show default info
	var lastUrlName = imgSrc.split('/').pop();
	document.title = lastUrlName;
	$("#iname").html(lastUrlName);

	// set additional image information
	if (no != null) {
        Rest.Image.get(no, function(imageInfo) {
        	var parentFolder = imageInfo.path.replace(/\\/gi, '/').split('/').pop();
			document.title = parentFolder + " : " + imageInfo.name;
			$("#paint").show().on("click", function() {
				Rest.Image.paint(no);
			});
	        $("#path").html(parentFolder).on("click", function() {
				Rest.Flay.openFolder(imageInfo.path);
		    });
			$("#iname").html(imageInfo.name);
			$("#length").html(File.formatSize(imageInfo.length));
			$("#lastModified").html(new Date(imageInfo.modified).format("yyyy-MM-dd"));
			$("#moveOut").show().on("click", function() {
	        	if (confirm('move this file to Root Directory?'))
		        	Rest.Image.delete(no);
	        });
        });
	}

	function getBrowserMargin() {
		var margin = {width: 0, height: 0};
		if (system === LINUX) {
			if (browser === CHROME) {
	   			margin.width = 0;
	   			margin.height = 28;
	   		} else if (browser === FIREFOX) {
	   			margin.width = 0;
	   			margin.height = 37;
	   		}
		} else if (system === WINDOWS) {
	   		if (browser === MSIE) {
	   			alert("Microsoft IE not support");
	   		} else if (browser === CHROME) {
	   			margin.width = 16;
	   			margin.height = 67;
	   		} else if (browser === FIREFOX) {
	   			margin.width = 16;
	   			margin.height = 76;
	   		} else if (browser === EDGE) {
	   			margin.width = 0;
	   			margin.height = 45;
	   		}
		}
		// console.log(system, browser, margin, agent);
		return margin;
	}

	function moveMagnifier(e) {
	    e.preventDefault(); // prevent any other actions that may occur when moving over the image
		function getCursorPos(e) {
		    var a, x = 0, y = 0;
		    e = e || window.event;
		    /*get the x and y positions of the image:*/
		    a = img.getBoundingClientRect();
		    /*calculate the cursor's x and y coordinates, relative to the image:*/
		    x = e.pageX - a.left;
		    y = e.pageY - a.top;
		    /*consider any page scrolling:*/
		    x = x - window.pageXOffset;
		    y = y - window.pageYOffset;
		    // console.log('getCursorPos', e.pageX, a.left, window.pageXOffset, x);
		    return {x: x, y: y, l: a.left, t: a.top};
		}
		
		glassSize = parseInt(sIze.value);
		zoom = parseInt(zOOm.value);
		glassHalfWidth  = $glass.width() / 2;
		glassHalfHeight = $glass.height() / 2;
		glassHalfWidthDividedZoom  = Math.round(glassHalfWidth / zoom);
		glassHalfHeightDividedZoom = Math.round(glassHalfHeight / zoom);

	    /*get the cursor's x and y positions:*/
	    cursor = getCursorPos(e);
	    /*prevent the magnifier glass from being positioned outside the image:*/
	    cursor.x = Math.min(cursor.x, img.width - glassHalfWidthDividedZoom);
	    cursor.x = Math.max(cursor.x, glassHalfWidthDividedZoom);
	    cursor.y = Math.min(cursor.y, img.height - glassHalfHeightDividedZoom);
	    cursor.y = Math.max(cursor.y, glassHalfHeightDividedZoom);

	    /* set the position of the magnifier glass: */
	    /* display what the magnifier glass "sees": */
	    $glass.css({
			backgroundSize: ($("#image").width() * zoom) + "px " + ($("#image").height() * zoom) + "px",
	    	backgroundPosition: (glassHalfWidth - (cursor.x * zoom) - bw) + "px " + (glassHalfHeight - (cursor.y * zoom) - bw) + "px",
			width: glassSize,
			height: glassSize,
	    	left: cursor.x + cursor.l - glassHalfWidth,
	    	top:  cursor.y + cursor.t - glassHalfHeight,
	    });
	}

};
</script>
</head>
<body>

	<div class="img-magnifier-container">
		<div id="glass" class="img-magnifier-glass"></div>
		<img id="image" class="img-responsive"/>
		<div id="info" class="overlay">
			<label id="magnifier"><i class="fa fa-search"></i></label>
			<label>px<input type="number" id="sIze" step="100" min="200" max="900"/></label>
			<label> x<input type="number" id="zOOm" step="1"   min="2"   max="9"/></label>
			<label id="paint"><i class="fa fa-paint-brush"></i></label>
			<label id="path"></label>
			<label id="iname"></label>
			<label id="size"></label>
			<label id="length"></label>
			<label id="lastModified"></label>
			<label id="moveOut"><i class="fa fa-times"></i></label>
		</div>
	</div>
	
</body>
</html>