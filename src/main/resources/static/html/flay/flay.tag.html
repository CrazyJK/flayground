<style type="text/css">
#tagInput .form-row {
	width: 800px;
}

#tagList {
	text-align: center;
	margin-top: 60px;
}
#tagList .tag {
	cursor: pointer;
	display: inline-flex;
	margin: 0.5rem;
	/* width: 200px; */
	font-size: 0.75rem;
}
#tagList .card-title {
	margin-right: 2rem;
}
#tagList .card-body {
	padding: 1rem;
}
#tagList .video-count {
	font-size: 0.75rem;
	float: right;
}
#tagList .active {
	background-color: rgba(85, 136, 136, .75);
	color: #eee;
}

#tagDetail {
	display: none;
    border-radius: 0.5rem;
    background-color: rgba(255, 255, 255, 0.5);
	margin: 1rem;
    padding: 1rem;
}
</style>

<div role="body">

	<nav class="navbar navbar-expand-sm fixed-top bg-light navbar-light justify-content-center">
		<form id="tagInput">
			<div class="form-row">
				<div class="col-sm-1">
					<input type="text" class="form-control form-control-sm" id="tagId"   name="id" placeholder="Id">
				</div>
				<div class="col-sm-3">
					<input type="text" class="form-control form-control-sm" id="tagName" name="name" placeholder="Name" required="required">
				</div>
				<div class="col">
					<input type="text" class="form-control form-control-sm" id="tagDesc" name="description" placeholder="Desctiption">
				</div>
				<div class="col-auto">
					<button class="btn btn-sm btn-success tag-save" type="submit">Save</button>
				</div>
				<div class="col-auto">
					<button class="btn btn-sm btn-danger tag-delete" type="submit">Delete</button>
				</div>
				<div class="col-auto">
	  				<span class="input-group">
						<label class="input"><input type="radio" name="openMethod" value="I" checked="checked"><span>In</span></label>
						<label class="input"><input type="radio" name="openMethod" value="E"><span>Out</span></label>
					</span>
				</div>
			</div>
		</form>
	</nav>
	
	<div id="tagList">
		<div class="card tag">
			<div class="card-body">
				<span class="badge badge-pill badge-dark video-count"></span>
				<h5 class="card-title font-weight-bold">Tag name</h5>
				<div class="card-text text-primary">Tag description</div>
			</div>
		</div>
	</div>
	
	<div id="tagDetail">
		<div class="text-right"><i class="fa fa-times hover"></i></div>
		<div class="flay-list"></div>
	</div>

</div>

<script type="text/javascript">
var $tagTemplete = $(".tag");

$("form").on('submit', function (e) {
    e.preventDefault();
});

$(".fa-times").on("click", function() {
	$("#tagDetail").hide();
});

$(".tag-save").on("click", function() {
	var tag = {};
	$.each($("#tagInput").serializeArray(), function() {
		tag[this.name] = this.value;
	});
	
	if (tag.id === '') {
		Rest.Tag.create(tag, tagLoad);
	} else {
		Rest.Tag.update(tag, tagLoad);
	}
});

$(".tag-delete").on("click", function() {
	var tag = $("#tagInput").data("tag");
	if (tag && tag.id && confirm('Delete this tag?\n' + JSON.stringify(tag))) {
		Rest.Tag.delete(tag, function() {
			tagLoad();
			$("#tagId, #tagName, #tagDesc").val('');
			$("#tagDetail").hide();
		});
	}
});

function tagLoad() {
	var $tagList = $("#tagList");
	Rest.Tag.list(function(tagList) {
		Util.Tag.sort(tagList);
		$tagList.empty();
		$.each(tagList, function(idx, tag) {
			var $tagCard = $tagTemplete.clone();
			$tagCard.data("tag", tag);
			$tagCard.find(".card-title").html(tag.name);
			$tagCard.find(".card-text").html(tag.description);
			$tagCard.on("click", function() {
				if ($("input[name='openMethod']:checked").val() === 'I')
					toggleTagDetail(this);
				else
					View.tag(tag.id);
			});
			$tagCard.appendTo($tagList);
		});
	});
}

function toggleTagDetail(tagCard) {
	var $tagCard   = $(tagCard);
	var $tagDetail = $("#tagDetail");
	if ($tagCard.hasClass("active")) { // hide
		$tagCard.removeClass("active");
		$tagDetail.hide();
	} else { // show
		$("#tagList .active").removeClass("active");
		$tagCard.addClass("active");
		var $flayList = $(".flay-list");
		$flayList.empty();

		var tag = $tagCard.data("tag");
		$("#tagInput").data("tag", tag);
		$("#tagId"  ).val(tag.id);
		$("#tagName").val(tag.name);
		$("#tagDesc").val(tag.description);
		
		Rest.Flay.findByTag(tag, function(flayList) {
			$tagCard.find(".video-count").html(flayList.length);
			if (flayList.length == 0) {
				$flayList.append(
						$("<h4>", {'class': 'text-danger font-weight-bold'}).html("No Flay")
				);
			} else {
				$.each(flayList, function(idx, flay) {
					$flayList.appendFlayCard(flay, {
						width: 300,
						exclude: [ACTRESS_EXTRA, MODIFIED, RANK, COMMENT, FILEINFO],
						fontSize: '80%'
					});
				});
			}
			$tagDetail.show();
		});
	}
}

tagLoad();

</script>