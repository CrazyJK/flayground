<!DOCTYPE html>
<html>
<head>
<title>Actress Info</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/png" href="/img/favicon/flay_1.png"/>
<link rel="stylesheet" href="/webjars/fontawesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/webjars/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/webjars/jquery-ui/jquery-ui.min.css"/>
<link rel="stylesheet" href="/css/base.scrollbar.css"/>
<link rel="stylesheet" href="/css/crazy.common.css"/>
<link rel="stylesheet" href="/css/flay.view.card.css"/>
<style type="text/css">
.actress-cover-wrapper {
	position: fixed;
	top: 9rem;
	left: 0;
	right: 0;
	height: 0;
    background-attachment: fixed;
	margin: .5rem;
	z-index: 74;
	transition: height 1s;
}
nav.navbar:hover ~ .actress-cover-wrapper {
	height: calc(100% - 9rem);
}
</style>
<script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/webjars/popper.js/umd/popper.js"></script>
<script type="text/javascript" src="/webjars/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/webjars/jquery-ui/jquery-ui.min.js"></script>
<script type="text/javascript" src="/js/crazy.common.js"></script>
<script type="text/javascript" src="/js/crazy.jquery.js"></script>
<script type="text/javascript" src="/js/flay.websocket.js"></script>
<script type="text/javascript" src="/js/flay.rest.service.js"></script>
<script type="text/javascript" src="/js/flay.utils.js"></script>
<script type="text/javascript" src="/js/flay.view.card.js"></script>
</head>
<body>

	<nav class="navbar navbar-expand-sm bg-light navbar-light justify-content-center sticky-top">
		<form onsubmit="return false;" id="infoForm">
			<div class="row mb-2">
				<div class="col-1">
					<button class="btn btn-outline-danger float-left" id="delete">Del</button>
				</div>
				<div class="col-4">
					<div class="input-group">
						<div class="input-group-prepend">
							<span class="input-group-text hover"><em class="fa fa-heart favorite" id="favorite"></em></span>
						</div>
						<input class="form-control text-center" name="name" id="name">
					</div>
				</div>
				<div class="col-3">
					<input class="form-control text-center" name="localName" id="localName" placeholder="LocalName...">
				</div>
				<div class="col-3">
					<button class="btn btn-outline-secondary" id="search">Search</button>
					<button class="btn btn-outline-secondary" id="find">Find</button>
					<button class="btn btn-outline-secondary" id="unseen">Unseen</button>
				</div>
				<div class="col-1">
					<button class="btn btn-outline-primary" id="save">Save</button>
				</div>
			</div>
			<div class="row mb-2">
				<div class="col-3">
					<div class="input-group">
						<input class="form-control text-center" name="birth" id="birth" placeholder="Birth...">
						<div class="input-group-append">
							<span class="input-group-text actress-age">0</span>
						</div>
					</div>
				</div>
				<div class="col-3">
					<input class="form-control text-center" name="body" id="body" placeholder="Body...">
				</div>
				<div class="col-2">
					<div class="input-group">
						<input class="form-control text-right" name="height" id="height" placeholder="Height...">
						<div class="input-group-append">
							<span class="input-group-text">cm</span>
						</div>
					</div>
				</div>
				<div class="col-2">
					<div class="input-group">
						<input class="form-control text-right" name="debut" id="debut" placeholder="Debut...">
						<div class="input-group-append">
							<span class="input-group-text">year</span>
						</div>
					</div>
				</div>
				<div class="col-2">
					<div class="input-group">
						<input class="form-control text-right" name="video_count" id="videoCount" readonly="readonly">
						<div class="input-group-append">
							<span class="input-group-text">Video</span>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col">
					<input type="text" class="form-control" id="comment" placeholder="comment...">
				</div>
			</div>
		</form>
	</nav>

	<div class="actress-cover-wrapper"></div>

	<div class="flay-list" style="overflow: auto;"></div>

<script type="text/javascript">
	var name = reqParam.name;
	var actress;

	var $flayList = $(".flay-list");

	$(window).on("resize", function() {
		$flayList.css({
			height: window.innerHeight - $(".navbar").outerHeight() - 16
		});
	});

	$("#favorite").on("click", function () {
		actress.favorite = !actress.favorite
		var $self = $(this);
		Rest.Actress.update(actress, function () {
			if (actress.favorite) {
				$self.switchClass('fa-heart-o', 'fa-heart favorite');
			} else {
				$self.switchClass('fa-heart favorite', 'fa-heart-o');
			}
		});
	});

	$("#birth").on("keyup", function () {
		var value = $(this).val();
		$(".actress-age").html(Util.Actress.getAge({ birth: value }));
	});

	$("#body").on("keyup", function () {
		var value = $(this).val().trim();
		var replace = value.replace(/^[A-Z]|\(|カップ\)/gi, '').replace(/\/ [A-Z]/gi, '- ');
		$(this).val(replace);
	});

	$("#search").on("click", function () {
		var keyword = actress.localName != '' ? actress.localName : actress.name;
		Search.actress(keyword);
	});

	$("#find").on("click", function () {
		var keyword = actress.localName != '' ? actress.localName : actress.name;
		Search.find(keyword);
	});

	$("#save").on("click", function () {
		var originalName = actress.name;
		actress.localName = $("#localName").val().trim();
		actress.birth = $("#birth").val().trim();
		actress.body = $("#body").val().trim();
		actress.height = $("#height").val().trim();
		actress.debut = $("#debut").val().trim();
		actress.name = $("#name").val().trim();
		actress.comment = $("#comment").val().trim();

		if (originalName != actress.name) {
			Rest.Actress.rename(originalName, actress, function () {
				location.href = "?name=" + actress.name;
			});
		} else {
			Rest.Actress.update(actress, function () {
				loading.on('Updated');
			});
		}
	});

	$("#unseen").on("click", function () {
		let active = $(this).data("active") !== true;
		let $flayList = $(".flay-list");
		$flayList.children().each(function (idx, flay) {
			let $flay = $(flay);
			let flayData = $flay.data("flay");
			if (active) {
				$flay.toggle(flayData.video.rank === 0 && !flayData.archive);
			} else {
				$flay.show();
			}
		});
		$(this).html(active ? 'All' : 'Unseen').data("active", active);
	});

	$("#delete").on("click", function () {
		confirm('confirm your order. delete this?') &&
			Rest.Actress.delete(actress, function () {
				self.close();
			});
	});

	Rest.Actress.get(name, function (_actress) {
		actress = _actress;
		document.title = actress.name + ' - ' + document.title;

		$("#name"     ).val(actress.name);
		$("#localName").val(actress.localName);
		$("#birth"    ).val(actress.birth).trigger('keyup');
		$("#body"     ).val(actress.body);
		$("#height"   ).val(actress.height.toBlank());
		$("#debut"    ).val(actress.debut.toBlank());
		$("#comment"  ).val(actress.comment);
		if (!actress.favorite) {
			$(".fa-heart").removeClass("favorite fa-heart").addClass("fa-heart-o");
		}

		var $flayList = $(".flay-list").empty();
		var flayAllList = [];
		Rest.Flay.findByActress(actress, function (flayList) {
			$("#videoCount").val(flayList.length);

			Rest.Flay.findByActressInArchive(actress, function (flayArchiveList) {
				$("#videoCount").val(flayList.length + " / " + (flayList.length + flayArchiveList.length));

				flayAllList = flayList.concat(flayArchiveList);

				flayAllList.sort(function (flay1, flay2) {
					var release1 = $.trim(flay1.release);
					var release2 = $.trim(flay2.release);
					return release2.toLowerCase().localeCompare(release1);
				});

				$.each(flayAllList, function (idx, flay) {
					$flayList.appendFlayCard(flay, {
						width: 330,
						exclude: [ACTRESS, MODIFIED, RANK, COMMENT, FILEINFO],
						fontSize: '80%',
						archive: flay.archive
					});
				});
			});
		});

		if (actress.coverSize > 0) {
			$("nav.navbar").hover(function () {
				$(".actress-cover-wrapper").css({
					background: 'rgba(0,0,0,0.75) url("/static/actress/' + actress.name + '/' + Random.getInteger(0, actress.coverSize - 1) + '") center top / contain no-repeat'
				});
			}, function () {
			});
		}

		$(window).trigger("resize");
	});

	$("body").toggleClass("bg-dark", LocalStorageItem.get('flay.bgtheme', 'D') === 'D').css({ backgroundColor: LocalStorageItem.get('flay.bgcolor') });

</script>
</body>
</html>