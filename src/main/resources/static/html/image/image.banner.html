<!DOCTYPE html>
<html>
<head>
<title>Image Banner</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" type="image/png" href="/img/favicon/flay_2.png" />
<link rel="stylesheet" href="/webjars/fontawesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/webjars/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/webjars/jquery-ui/jquery-ui.min.css"/>
<link rel="stylesheet" href="/css/crazy.common.css">
<link rel="stylesheet" href="/css/base.scrollbar.css"/>
<style type="text/css">
body {
	font-family: D2Coding;
	background-color: #000 !important;
	color: #ccc;
	overflow: hidden;
}
pre {
	position: absolute;
	background-size: contain;
    background-repeat: no-repeat;
	cursor: crosshair;
	font-family: Consolas;
	font-size: 10px;
	line-height: 11px;
	overflow: hidden;
	transition: all 0.4s ease 0s;
}
pre.hide-bg {
	background: none!important;
}
#controlBox {
	position: fixed;
    bottom: 1px;
    right: 0;
    width: 160px;
    text-align: center;
    border: 1px solid #333;
    border-top-left-radius: 0.25rem;
    color: #f8f9fa;
    background-color: #111;
    margin: 0;
}
ul#controlBox {
	list-style: none;
    padding-left: 0;
}
#controlBox > li {
	margin: .5rem .25rem;
	font-size: 80%;
	font-weight: 400;
}
#controlBox > li:last-child {
	margin: .25rem;
}
#controlBox > li > .number-group {
	border: 1px solid #333;
	display: flex;
    flex-wrap: wrap;
}
#controlBox > li > .number-group > label {
	margin: 0;
	padding: 0 4px;
	color: #546678;
	font-weight: 500;
}
#controlBox > li > .number-group > input {
	background-color: transparent;
	border: 0;
	color: #ccc;
	text-align: right;
	flex: 1 1 auto;
	width: 0;
}
#controlBox > li > .number-group > input:focus {
	border: 0;
	outline: 0;
}
#controlBox > li > div.custom-control {
	margin: 0 .25rem;
}
#imageThumbPanel {
}
#imageThumbPanel > img {
	width: 100%;
}
.custom-control > * {
	cursor: pointer;
}
#controlToggleBtn {
	cursor: pointer;
	transition: all .4s;
	border-radius: .25rem;
	height: 16px;
}
#controlToggleBtn:hover {
	background-color: #444;
}
</style>
<script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/js/crazy.common.js"></script>
<script type="text/javascript" src="/js/crazy.jquery.js"></script>
<script type="text/javascript" src="/js/flay.rest.service.js"></script>
<script type="text/javascript" src="/js/flay.utils.js"></script>
<script type="text/javascript">
//1 x 1 pixel transparent
const blackDataUrl = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";

var imageTotal		 = Rest.Image.size();
var imageIndex		 = LocalStorageItem.get('image.banner.index', Random.getInteger(0, imageTotal));
var panelWidth		 = LocalStorageItem.get('image.banner.width', 150);
var bitDepthVal      = LocalStorageItem.get('image.banner.bitDepth', 'FOUR');
var pixelModeVal     = LocalStorageItem.get('image.banner.pixelMode', 'TEXT');
var invertVal 		 = LocalStorageItem.getBoolean('image.banner.invert', false);
var randomVal  		 = LocalStorageItem.getBoolean('image.banner.random', false);
var autofitVal 		 = LocalStorageItem.getBoolean('image.banner.autofit', false);
var showThumbnailVal = LocalStorageItem.getBoolean('image.banner.showThumbnailSwitch', false);
var overlapImageVal  = LocalStorageItem.getBoolean('image.banner.overlapImageSwitch', false);
var overlapBannerVal = LocalStorageItem.getBoolean('image.banner.overlapBannerSwitch', false);
var playIntervalVal  = LocalStorageItem.getInteger('image.banner.play.interval', 5);
var playIntervalID;
var isPlay = false;
var bannerText = "", bannerBlank = "";

$(document).ready(function() {
	// initiate
	$("#totalImageCount").html(imageTotal);
	$("#index").val(imageIndex);
	$("#width").val(panelWidth);
	$("#invert").prop('checked', invertVal);
	$("#random").prop('checked', randomVal);
	$("#autofit").prop('checked', autofitVal);
	$("#playInterval").val(playIntervalVal);
	$("input:radio[name='bitDepth']:radio[value='" + bitDepthVal + "']").prop('checked', true);
	$("input:radio[name='pixelMode']:radio[value='" + pixelModeVal + "']").prop('checked', true);
	$("#showThumbnailSwitch").prop('checked', showThumbnailVal);
	$("#overlapImageSwitch").prop('checked', overlapImageVal);
	$("#overlapBannerSwitch").prop('checked', overlapBannerVal);
	$("#imageThumbPanel").toggle(showThumbnailVal);

	// event listener
	$("#invert, input[name='bitDepth'], input[name='pixelMode']").on("click", function(e) {
		show();
	});
	$("#index, #width").on("keyup", function(e) {
		e.preventDefault();
		e.stopPropagation();
		if (e.keyCode === 13) {
			show();
		}
	});
	$("#prevBtn").on("click", function(e) {
		if (--imageIndex < 0) {
			imageIndex = imageTotal - 1;
		}
		$("#index").val(imageIndex);
		show();
	});
	$("#nextBtn").on("click", function(e) {
		if (randomVal) {
			imageIndex = Random.getInteger(0, imageTotal)
		} else {
			++imageIndex;
		}
		if (imageIndex >= imageTotal) {
			imageIndex = 0;
		}
		$("#index").val(imageIndex);
		show();
	});
	$("#playBtn").on("click", function() {
		isPlay = !$(this).data("isPlay");
		Progress.play.init(0.2, playIntervalVal);
		if (isPlay) {
			playIntervalID = setInterval(function() {
				$("#nextBtn").click();
				Progress.play.run();
			}, 1000 * playIntervalVal);
			Progress.play.run();
		} else {
			clearInterval(playIntervalID);
			Progress.play.stop();
		}
		$(this).data("isPlay", isPlay).html(isPlay ? 'STOP' : 'PLAY');
	}).data("state", false);
	$("#random").on("change", function(e) {
		randomVal = $("#random").is(":checked");
		LocalStorageItem.set('image.banner.random', randomVal);
	});
	$("#autofit").on("change", function(e) {
		autofitVal = $("#autofit").is(":checked");
		$("#width").prop('readonly', autofitVal);
		LocalStorageItem.set('image.banner.autofit', autofitVal);
	}).trigger("change");
	$("#playInterval").on("change", function() {
		playIntervalVal = parseInt($(this).val());
		LocalStorageItem.set('image.banner.play.interval', playIntervalVal);
	});
	$("#showThumbnailSwitch").on("change", function(e) {
		showThumbnailVal = $(this).is(':checked');
		$("#imageThumbPanel").toggle(showThumbnailVal);
		LocalStorageItem.set('image.banner.showThumbnailSwitch', showThumbnailVal);
	});
	$("#overlapImageSwitch").on("change", function(e) {
		overlapImageVal = $(this).is(':checked');
		$("pre#banner").toggleClass('hide-bg', !overlapImageVal);
		LocalStorageItem.set('image.banner.overlapImageSwitch', overlapImageVal);
	}).trigger("change");
	$("#overlapBannerSwitch").on("change", function(e) {
		overlapBannerVal = $(this).is(':checked');
		$("pre#banner").text(overlapBannerVal ? bannerText : bannerBlank);
		LocalStorageItem.set('image.banner.overlapBannerSwitch', overlapBannerVal);
	}).trigger("change");
	$("body").navEvent(function(signal, e) {
		// console.log('navEvent', signal);
		switch (signal) {
		case 84: // 'T'
			$("#showThumbnailSwitch").click();
			break;
		case 66: // 'B'
			$("#overlapBannerSwitch").click();
			break;
		case 73: // 'I'
			$("#overlapImageSwitch").click();
			break;
		case 77: // 'M'
			$("#controlToggleBtn").click();
			break;
		case 80: // 'P'
			$("#playBtn").click();
			break;
		case 82: // 'R'
			$("#random").click();
			break;
		case 65: // 'A'
			$("#autofit").click();
			break;
		case 37: // key left
			$("#prevBtn").click();
			break;
		case 39: // right
			$("#nextBtn").click();
			break;
		case 1001: // left mouse click
			if ($("#playBtn").data("isPlay")) { // stop play
				$("#playBtn").click();
			}
			break;
		}
	});
	$("#controlToggleBtn").on("click", function() {
		$("#controlBox > li:not(:last-child)").toggle();
	});
	$("img#image").on("click", function() {
		Popup.imageByNo(imageIndex);
	});
	$(".monitor-size").on("click", function() {
		$("#width").val($(this).text());
		show();
	});

	show();
});

function show() {
	imageIndex = parseInt($("#index").val());
	if (autofitVal) {
		panelWidth = Math.round(window.innerWidth / 5.5);
		$("#width").val(panelWidth);
	} else {
		panelWidth = $("#width").val();
	}
	// console.log('show', imageIndex);
	
	// load banner
	loadBanner();

	// load Image
	loadImage();
}

function loadBanner() {
	// reset banner
	$("pre#banner").css({
		backgroundImage: 'url(' + blackDataUrl + ')',
		width: 'calc(' + panelWidth + ' * 5.5px)'
	}).empty();

	restCall(PATH + '/banner/' + imageIndex + '/' + panelWidth + '/0', {
		mimeType : "text/plain",
		loadingDelay: 2000,
		data: $("form").serialize()
	}, function(text) {
		bannerText = text;
		bannerBlank = text.replace(/./g, '') + '\n';
		$("pre#banner").text(overlapBannerVal ? bannerText : bannerBlank);

		// overflow-y scale fix
		var scale = 1;
		var degree = 0;
		var topOffset = 0;
		if (autofitVal) {
			var bannerWidth  = $("pre#banner").width();
			var bannerHeight = $("pre#banner").height();
			var bannerVerticalRatio = bannerHeight / bannerWidth;
			var isBannerVertical = bannerWidth < bannerHeight;
			var isWindowVertical = window.innerWidth < window.innerHeight;
			if (isBannerVertical !== isWindowVertical && (bannerVerticalRatio < 0.8 || 1.2 < bannerVerticalRatio)) {
				degree = 90;
				scale = window.innerHeight / bannerWidth;
				topOffset = bannerWidth * scale / 2 - bannerHeight / 2;
			} else {
				scale = window.innerHeight / bannerHeight;
				topOffset = bannerHeight * (scale - 1) / 2;
			}
		}
		$("pre#banner").css({
			transform: "scale(" + scale.toFixed(2) + ")" + " rotate(" + degree + "deg)",
			top: topOffset.toFixed(0) + "px"
		});
		console.log({
			bannerSize: bannerWidth + " x " + bannerHeight, 
			isBannerVertical: isBannerVertical, 
			bannerVerticalRatio: bannerVerticalRatio, 
			windowSize: window.innerWidth + " x " + window.innerHeight,
			isWindowVertical:  isWindowVertical, 
			scale: scale.toFixed(2), 
			degree: degree, 
			topOffset: topOffset.toFixed(0)
		});
		
		// page progress
		Progress.page(imageIndex + 1, imageTotal);
		
		if (isPlay) {
			setTimeout(function() {
				$("pre#banner").text(bannerBlank);
			}, 1000 * (playIntervalVal * 2/3));
		}
		
		LocalStorageItem.set('image.banner.index', imageIndex);
		LocalStorageItem.set('image.banner.width', panelWidth);
		LocalStorageItem.set('image.banner.invert', $("input[name='invert']").is(":checked"));
		LocalStorageItem.set('image.banner.bitDepth', $("input:radio[name='bitDepth']:checked").val());
		LocalStorageItem.set('image.banner.pixelMode', $("input:radio[name='pixelMode']:checked").val());
	}, function(jqXHR, textStatus, errorThrown) {
		loading.on(new Text("Could not load the banner :( " + image.src + " - " + textStatus + " - " + errorThrown));
	});
}

function loadImage() {
	let image = new Image();
	image.src = PATH + "/static/image/" + imageIndex;
	image.decode().then(() => {
		// $("#imageSize").html(image.naturalWidth + ' x ' + image.naturalHeight);
		
		// get image dataurl
		let canvas = document.createElement('canvas');
	   	canvas.width = image.naturalWidth;
	   	canvas.height = image.naturalHeight;
	   	canvas.getContext('2d').drawImage(image, 0, 0);
	   	let imageDataUrl = canvas.toDataURL('image/png');
	   	// console.log(imageUri);
		
		// append image data
		$("img#image").attr("src", imageDataUrl);

		// overlap background
		setTimeout(function() {
			$("pre#banner").css({
				backgroundImage: 'url(' + imageDataUrl + ')'
			});
		}, 1000 * (overlapBannerVal ? playIntervalVal * 1/3 : 0));

		// load image info
		Rest.Image.get(imageIndex, function(info) {
			$("#imageTitle").html(info.name);
		});
	}).catch((e) => {
		loading.on(new Text("Could not load the image :( " + image.src + " - " + e));
	});
}

var Progress = {};
Progress.page = function(curr, total) {
	$("#paginationProgress.progress > div.progress-bar").css({
		width: (curr / total * 100).toFixed(1) + "%"
	});
};
Progress.play = {
		max: 5,
		step: 0.1,
		curr: 0,
		intervalID: null,
		init: function(step, max) {
			Progress.play.step = step;
			Progress.play.max = max;
			$("#playProgress.progress > div.progress-bar").css({
				transition: "width " + step + "s linear 0s"
			});
		},
		run: function() {
			Progress.play.curr = 0;
			clearInterval(Progress.play.intervalID);
			Progress.play.intervalID = setInterval(function() {
				Progress.play.curr += Progress.play.step;
				$("#playProgress.progress > div.progress-bar").css({
					width: (Progress.play.curr / Progress.play.max * 100).toFixed(1) + "%",
					height: "1px"
				});
			}, 1000 * Progress.play.step);
			
		},
		stop: function() {
			Progress.play.curr = 0;
			clearInterval(Progress.play.intervalID);
			$("#playProgress.progress > div.progress-bar").css({
				width: 0,
				height: 0
			});
		}
};
</script>
</head>
<body class="bg-dark">

	<div class="container-fluid mt-4">
		<pre id="banner" class="text-light rounded"></pre>
	</div>

	<form action="#" onsubmit="return false;">
		<ul id="controlBox">
			<li>
				<div class="border border-dark collapse rounded" id="imageThumbPanel">
					<img id="image">
					<div id="imageTitle" class="nowrap"></div>
					<div id="imageSize"></div>
				</div>
			</li>
			<li class="text-left">
				<div class="custom-control custom-switch">
					<input type="checkbox" class="custom-control-input" id="showThumbnailSwitch">
					<label class="custom-control-label" for="showThumbnailSwitch">show Thumbnail</label>
				</div>
				<div class="custom-control custom-switch">
					<input type="checkbox" class="custom-control-input" id="overlapImageSwitch">
					<label class="custom-control-label" for="overlapImageSwitch">overlap Image</label>
				</div>
				<div class="custom-control custom-switch">
					<input type="checkbox" class="custom-control-input" id="overlapBannerSwitch">
					<label class="custom-control-label" for="overlapBannerSwitch">overlap Banner</label>
				</div>
			</li>
			<li>
				<div class="number-group">
					<label>Index <span id="totalImageCount"></span></label>
					<input type="number" id="index" title="image index" min="0">
				</div>
			</li>
			<li>
				<div class="number-group">
					<label>Banner width</label>
					<input type="number" id="width" title="banner width" min="100" max="800">
					<div class="d-flex w-100">					
						<span class="hover mx-2 flex-fill monitor-size">190</span>
						<span class="hover mx-2 flex-fill monitor-size">460</span>
						<span class="hover mx-2 flex-fill monitor-size">342</span>
					</div>
				</div>
			</li>
			<li>
				<div class="number-group">
					<label>Play Interval</label>
					<input type="number" id="playInterval" title="play Interval" min="3" style="width:0;">
				</div>
			</li>
			<li>
				<div class="progress bg-dark" id="playProgress" style="height: 1px; border-radius: 0;">
		  			<div class="progress-bar bg-primary" style="width: 0; height: 1px;"></div>
				</div>
				<div class="btn-group btn-group-sm btn-block">
					<button class="btn btn-flay" id="prevBtn" type="button">PREV</button>
					<button class="btn btn-flay" id="playBtn" type="button">PLAY</button>
					<button class="btn btn-flay" id="nextBtn" type="button">NEXT</button>
				</div>
			</li>
			<li class="text-left pl-4">
				<div class="custom-control custom-switch">
					<input type="checkbox" class="custom-control-input" id="random">
					<label class="custom-control-label" for="random">Random</label>
				</div>
				<div class="custom-control custom-switch">
					<input type="checkbox" class="custom-control-input" id="autofit">
					<label class="custom-control-label" for="autofit">Autofit</label>
				</div>
				<div class="custom-control custom-switch">
					<input type="checkbox" class="custom-control-input" id="invert" name="invert">
					<label class="custom-control-label" for="invert">Invert</label>
				</div>
			</li>
			<li>
				<div class="custom-control custom-radio custom-control-inline" title="bitDepth 4">
					<input type="radio" class="custom-control-input" id="bitDepth1" name="bitDepth" value="FOUR" checked="checked">
					<label class="custom-control-label" for="bitDepth1">FOUR</label>
				</div>
				<div class="custom-control custom-radio custom-control-inline" title="bitDepth 8">
					<input type="radio" class="custom-control-input" id="bitDepth2" name="bitDepth" value="EIGHT">
					<label class="custom-control-label" for="bitDepth2">EIGHT</label>
				</div>
			</li>
			<li>
				<div class="custom-control custom-radio custom-control-inline" title="pixelMode text">
					<input type="radio" class="custom-control-input" id="pixelMode1" name="pixelMode" value="TEXT" checked="checked">
					<label class="custom-control-label" for="pixelMode1">TEXT</label>
				</div>
				<div class="custom-control custom-radio custom-control-inline" title="pixelMode block">
					<input type="radio" class="custom-control-input" id="pixelMode2" name="pixelMode" value="BLOCK">
					<label class="custom-control-label" for="pixelMode2">BLOCK</label>
				</div>
			</li>
			<li>
				<div id="controlToggleBtn">
					<i class="fa fa-caret-up" aria-hidden="true"></i>
					<i class="fa fa-caret-down" aria-hidden="true"></i>
				</div>
			</li>
		</ul>
	</form>

	<nav class="fixed-bottom">
		<div class="progress bg-dark" id="paginationProgress" style="height: 1px; border-radius: 0;">
  			<div class="progress-bar bg-danger" style="width: 100%; height: 1px;"></div>
		</div>
	</nav>

</body>
</html>